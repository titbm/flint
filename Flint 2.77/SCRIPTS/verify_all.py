#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
═══════════════════════════════════════════════════════════════════════
  UNIFIED VERIFICATION: Flint v2.77 Source Files vs PROJ5.EXE Binary
  Consolidates all checks from 10 verification scripts into one test.
  Covers: PROJ5.CPP, PIC.CPP, RDWRF.CPP, MSKEYC.CPP, PROJ5.H
═══════════════════════════════════════════════════════════════════════
"""
import struct, os, sys, re

# ─── Paths ─────────────────────────────────────────────────────────
SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
EXE_DIR = os.path.dirname(SCRIPT_DIR)
SRC_DIR = os.path.join(os.path.dirname(EXE_DIR), "Flint 2.77 src")
EXE_PATH = os.path.join(EXE_DIR, "PROJ5.EXE")

# ─── Binary layout ─────────────────────────────────────────────────
HDR       = 0x1E00
SEG       = 0x09280    # PROJ5.CPP segment
PIC_SEG   = 0x115C0    # PIC.CPP segment
RDWRF_SEG = 0x12290    # RDWRF.CPP segment
MSKEYC_SEG= 0x13C20    # MSKEYC.CPP segment
DS        = 0x1AB30    # Data segment (absolute file offset)

# ─── Counters ──────────────────────────────────────────────────────
passed = 0
failed = 0
sec_stats = {}
cur_sec = ""
fail_details = []

def section(name):
    global cur_sec
    cur_sec = name
    sec_stats[name] = [0, 0]

def chk(tag, off, exp):
    global passed, failed
    got = exe[off:off+len(exp)]
    if got == exp:
        passed += 1; sec_stats[cur_sec][0] += 1
    else:
        failed += 1; sec_stats[cur_sec][1] += 1
        m = f"FAIL {tag}: @0x{off:05X} exp={exp.hex()} got={got.hex()}"
        print(f"  {m}"); fail_details.append(m)

def chk_val(tag, cond, detail=""):
    global passed, failed
    if cond:
        passed += 1; sec_stats[cur_sec][0] += 1
    else:
        failed += 1; sec_stats[cur_sec][1] += 1
        m = f"FAIL {tag}" + (f" -- {detail}" if detail else "")
        print(f"  {m}"); fail_details.append(m)

def chk_str(tag, ds_off, exp):
    global passed, failed
    foff = DS + ds_off
    got = exe[foff:foff+len(exp)+1]
    if got == exp + b'\x00':
        passed += 1; sec_stats[cur_sec][0] += 1
    else:
        failed += 1; sec_stats[cur_sec][1] += 1
        m = f"FAIL {tag}: DS:0x{ds_off:04X} exp={exp!r} got={got!r}"
        print(f"  {m}"); fail_details.append(m)

# Segment offset → absolute file offset
def flat(off):  return HDR + SEG + off
def pic(off):   return HDR + PIC_SEG + off
def rdw(off):   return HDR + RDWRF_SEG + off
def msk(off):   return HDR + MSKEYC_SEG + off

def chk_lcall(tag, seg_off, tgt_off, tgt_seg):
    chk(tag, flat(seg_off), b'\x9a' + struct.pack('<HH', tgt_off, tgt_seg))

def chk_p16(tag, seg_off, val):
    chk(tag, flat(seg_off), b'\x68' + struct.pack('<H', val))

def chk_p8(tag, seg_off, val):
    chk(tag, flat(seg_off), bytes([0x6a, val & 0xff]))

# ─── Load EXE ──────────────────────────────────────────────────────
if not os.path.exists(EXE_PATH):
    print(f"ERROR: {EXE_PATH} not found!"); sys.exit(1)
with open(EXE_PATH, 'rb') as f:
    exe = f.read()

print("=" * 70)
print("  UNIFIED VERIFICATION: Flint v2.77 src vs PROJ5.EXE")
print(f"  EXE size: {len(exe)} bytes")
print("=" * 70)

section("EXE integrity")
chk_val("EXE size = 119952", len(exe) == 119952, f"got {len(exe)}")

# ═════════════════════════════════════════════════════════════════════
#  PROJ5.CPP — main() at seg+0x000E  (158 checks)
# ═════════════════════════════════════════════════════════════════════
section("main()")
chk("enter_0x0e", flat(0x000E), b'\xc8\x0e\x00\x00')
chk("push_si_di", flat(0x0012), b'\x56\x57')
chk("init_g_driver", flat(0x0014), b'\xc7\x46\xf8\x00\x00')
chk("init_f_demo", flat(0x0019), b'\xc7\x06\x60\x29\x00\x00')
chk("init_f_bcab", flat(0x001F), b'\xc7\x06\x62\x29\x00\x00')
chk("init_f_bca", flat(0x0025), b'\xc7\x06\x64\x29\x00\x00')
chk("init_f_bc", flat(0x002B), b'\xc7\x06\x66\x29\x00\x00')
chk("init_f_sort", flat(0x0031), b'\xc7\x06\xd2\x29\x00\x00')
chk("init_sK1_15", flat(0x0037), b'\xc7\x06\xd4\x29\x0f\x00')
chk("init_sK2_10", flat(0x003D), b'\xc7\x06\xd6\x29\x0a\x00')
chk("init_f_xyz", flat(0x0043), b'\xc7\x06\x7a\x29\x00\x00')
chk("init_f_data", flat(0x0049), b'\xc7\x06\x78\x29\x00\x00')
chk("init_start_nmb", flat(0x004F), b'\x66\xc7\x06\x7c\x29\x00\x00\x00\x00')
chk("init_lastn", flat(0x0058), b'\x66\xc7\x06\x80\x29\x00\x00\x00\x00')
chk("init_nmax", flat(0x0061), b'\x66\xc7\x06\x84\x29\x00\x00\x00\x00')
chk("init_tout", flat(0x006A), b'\xc7\x06\xdc\x29\x00\x00')
chk("init_do_ptr", flat(0x0070), b'\xc7\x06\x6e\x29\x00\x00')
chk("init_f_ptr", flat(0x0076), b'\xc7\x06\x70\x29\x00\x00')
chk("strcpy_glstype_src", flat(0x007C), b'\x1e\x68\xc7\x0e')
chk("strcpy_glstype_dst", flat(0x0080), b'\x1e\x68\x98\x29')
chk("strcpy_glstype_lcall", flat(0x0084), b'\x9a\xec\x1b\x00\x00')
chk("nglas_fld", flat(0x008C), b'\x9b\xdd\x06\xca\x0e')
chk("nglas_fstp", flat(0x0091), b'\x9b\xdd\x1e\xa2\x29')
chk("init_xsize_500", flat(0x0098), b'\xc7\x06\xaa\x29\xf4\x01')
chk("init_ysize_500", flat(0x009E), b'\xc7\x06\xac\x29\xf4\x01')
chk("init_zsize_500", flat(0x00A4), b'\xc7\x06\xae\x29\xf4\x01')
chk("init_xofs", flat(0x00AA), b'\xc7\x06\xb0\x29\x00\x00')
chk("init_yofs", flat(0x00B0), b'\xc7\x06\xb2\x29\x00\x00')
chk("init_zofs", flat(0x00B6), b'\xc7\x06\xb4\x29\x00\x00')
chk("init_xcur", flat(0x00BC), b'\xc7\x06\x72\x29\x00\x00')
chk("init_ycur", flat(0x00C2), b'\xc7\x06\x74\x29\x00\x00')
chk("init_zcur", flat(0x00C8), b'\xc7\x06\x76\x29\x00\x00')
chk("init_dx_20", flat(0x00CE), b'\xc7\x06\x44\x2a\x14\x00')
chk("init_dy_20", flat(0x00D4), b'\xc7\x06\x46\x2a\x14\x00')
chk("init_dz_60", flat(0x00DA), b'\xc7\x06\x48\x2a\x3c\x00')
chk("init_nmb_pbt_255", flat(0x00E0), b'\xc7\x06\xd8\x29\xff\x00')
chk("init_gl_nmb_1", flat(0x00E6), b'\xc7\x06\xb6\x29\x01\x00')
chk("init_d_check_1", flat(0x00EC), b'\xc7\x06\xce\x29\x01\x00')
chk("init_f_noise_0", flat(0x00F2), b'\xc7\x06\xd0\x29\x00\x00')
chk("k_1", flat(0x00F8), b'\xbf\x01\x00')
chk("all_1", flat(0x00FB), b'\xbe\x01\x00')
chk("init_fcdim", flat(0x00FE), b'\xc7\x06\x4a\x2a\x01\x00')
chk("init_kdim_100", flat(0x0104), b'\xc7\x06\x4c\x2a\x64\x00')
chk("init_feqk", flat(0x010A), b'\xc7\x06\x4e\x2a\x01\x00')
chk("init_kxdim_100", flat(0x0110), b'\xc7\x06\x50\x2a\x64\x00')
chk("init_kydim_100", flat(0x0116), b'\xc7\x06\x52\x2a\x64\x00')
chk("init_kzdim_100", flat(0x011C), b'\xc7\x06\x54\x2a\x64\x00')
chk("call_ClearRpt", flat(0x0122), b'\x90\x0e\xe8\x6e\x42')
chk("push_gl_nmb", flat(0x0127), b'\xff\x36\xb6\x29')
chk("lcall_RdCfg", flat(0x012B), b'\x9a\xda\x00\x29\x12')
chk("lcall_CurDir", flat(0x0131), b'\x9a\xe4\x04\x29\x12')
chk("strcpy_wrkpath_src", flat(0x0136), b'\x1e\x68\x96\x57')
chk("strcpy_wrkpath_dst", flat(0x013A), b'\x1e\x68\xde\x29')
chk("strcpy_wrkpath_lcall", flat(0x013E), b'\x9a\xec\x1b\x00\x00')
chk("lcall_registerbgi", flat(0x014C), b'\x9a\xf4\x03\xf1\x13')
chk("registerbgi_check", flat(0x0154), b'\x0b\xc0\x7d\x06')
chk("lcall_initgraph", flat(0x016C), b'\x9a\x79\x09\xf1\x13')
chk("lcall_graphresult", flat(0x0174), b'\x9a\x0d\x03\xf1\x13')
chk("graphresult_cmp", flat(0x017C), b'\x83\x7e\xfa\x00\x74\x12')
chk("lcall_pi_ini", flat(0x0194), b'\x9a\x02\x00\x5c\x11')
chk("pi_ini_check", flat(0x0199), b'\x0b\xc0\x75\x06')
chk("f_demo_set_1", flat(0x019D), b'\xc7\x06\x60\x29\x01\x00')
chk("lcall_ms_init", flat(0x01A3), b'\x9a\x3a\x00\xc2\x13')
chk("set_gr_cursor_params", flat(0x01A8), b'\x1e\x68\x52\x09\x6a\x00\x6a\x00')
chk("lcall_set_gr_cursor", flat(0x01B0), b'\x9a\x01\x00\xc2\x13')
chk("lcall_farcoreleft", flat(0x01B8), b'\x9a\x9a\x4a\x00\x00')
chk("farcoreleft_to_eax", flat(0x01BD), b'\x52\x50\x66\x58')
chk("sub_30000", flat(0x01C1), b'\x66\x2d\x30\x75\x00\x00')
chk("store_ulMax", flat(0x01C7), b'\x66\xa3\x3c\x2a')
chk("push_ulMax", flat(0x01CB), b'\x66\xff\x36\x3c\x2a')
chk("lcall_farmalloc", flat(0x01D0), b'\x9a\x5c\x47\x00\x00')
chk("farmalloc_check", flat(0x01DF), b'\x0b\xc2\x75\x0c')
chk("alloc_fail_printf", flat(0x01E3), b'\x1e\x68\xf1\x0e')
chk("alloc_fail_lcall", flat(0x01E7), b'\x9a\x2b\x30\x00\x00')
chk("alloc_fail_goto_b", flat(0x01EC), b'\xe9\xc3\x01')
chk("ulMax_div6_ebx", flat(0x01EF), b'\x66\xbb\x06\x00\x00\x00')
chk("ulMax_div6_ops", flat(0x01F5), b'\x66\xa1\x3c\x2a\x66\x33\xd2\x66\xf7\xf3\x66\xa3\x3c\x2a')
chk("lcall_FlashRd", flat(0x0203), b'\x9a\x26\x03\x29\x12')
chk("setlinestyle_params", flat(0x0208), b'\x6a\x01\x6a\x01\x6a\x00')
chk("lcall_setlinestyle", flat(0x020E), b'\x9a\x5d\x11\xf1\x13')
chk("if_k_check", flat(0x0216), b'\x0b\xff\x74\x07')
chk("push_all_call_mainscr", flat(0x021A), b'\x56\x90\x0e\xe8\x8c\x41')
chk("all_1_k_1", flat(0x0221), b'\xbe\x01\x00\xbf\x01\x00')
chk("scan_ms_push_0", flat(0x0227), b'\x6a\x00')
chk("scan_ms_push_7", flat(0x0229), b'\x6a\x07')
chk("scan_ms_push_bnam", flat(0x022B), b'\x1e\x68\x96\x00')
chk("scan_ms_push_btc", flat(0x022F), b'\x1e\x68\xb2\x00')
chk("call_scan_ms", flat(0x0235), b'\xe8\x88\x5b')
chk("switch_cx_8", flat(0x0244), b'\xb9\x08\x00')
chk("case0_cmp_f_xyz", flat(0x025D), b'\x83\x3e\x7a\x29\x02\x7e\x04')
chk("case0_xor_ax", flat(0x0264), b'\x33\xc0\xeb\x04')
chk("case0_inc_xyz", flat(0x0268), b'\xa1\x7a\x29\x40')
chk("case0_store_break", flat(0x026C), b'\xa3\x7a\x29\x33\xf6\xeb\x95')
chk("case3_dlgopen_push0", flat(0x0273), b'\x6a\x00')
chk("case3_dlgopen_str", flat(0x0275), b'\x1e\x68\x02\x0f')
chk("case3_call_dlgopen", flat(0x027F), b'\x90\x0e\xe8\xca\x16')
chk("case3_dlgopen_check", flat(0x0287), b'\x0b\xc0\x0f\x84\xc6\x00')
chk("case3_lastn_0", flat(0x028D), b'\x66\xc7\x06\x80\x29\x00\x00\x00\x00')
chk("case3_f_bc_cmp", flat(0x02C7), b'\x83\x3e\x66\x29\x00\x74\x0d')
chk("case3_lcall_rdcft_t", flat(0x02D4), b'\x9a\x7d\x07\x29\x12')
chk("case3_lcall_rdbft_t", flat(0x02E1), b'\x9a\xf8\x15\x29\x12')
chk("case3_nmax_store", flat(0x02E9), b'\x89\x16\x86\x29\xa3\x84\x29')
chk("case3_nmax_cmp0", flat(0x0304), b'\x66\x83\x3e\x84\x29\x00\x75\x0a')
chk("case3_nmax_gt0", flat(0x0316), b'\x66\x83\x3e\x84\x29\x00\x7e\x1a')
chk("case3_f_data_1", flat(0x031E), b'\xc7\x06\x78\x29\x01\x00')
chk("case3_tout_1", flat(0x034B), b'\xc7\x06\xdc\x29\x01\x00')
chk("case3_else_nmax_0", flat(0x0363), b'\x66\xc7\x06\x84\x29\x00\x00\x00\x00')
chk("case3_else_lastn_0", flat(0x036C), b'\x66\xc7\x06\x80\x29\x00\x00\x00\x00')
chk("case3_else_tout_0", flat(0x0375), b'\xc7\x06\xdc\x29\x00\x00')
chk("case3_else_f_data_0", flat(0x037B), b'\xc7\x06\x78\x29\x00\x00')
chk("case3_call_chdiska", flat(0x0381), b'\x90\x0e\xe8\x49\x35')
chk("case4_call_dlgload", flat(0x0389), b'\x90\x0e\xe8\x21\x37')
chk("case4_jmp_all0", flat(0x038E), b'\xe9\xde\xfe')
chk("case6_push_params", flat(0x0391), b'\x6a\x00\x6a\x00\x1e\x68\x4b\x0f')
chk("case6_call_msgbox", flat(0x0399), b'\x90\x0e\xe8\x0d\x04')
chk("case6_msgbox_check", flat(0x03A1), b'\x0b\xc0\x74\x1f')
chk("case6_push_iTabl", flat(0x03A5), b'\xff\x36\x42\x2a\xff\x36\x40\x2a')
chk("case6_lcall_farfree", flat(0x03AD), b'\x9a\x48\x46\x00\x00')
chk("label_b_closegraph", flat(0x03B5), b'\x9a\x3e\x0e\xf1\x13')
chk("exit_outportb_LRG_0", flat(0x03BA), b'\xba\x1c\x03\xb0\x00\xee')
chk("exit_return_0", flat(0x03C0), b'\x33\xc0\xeb\x3a')
chk("case6_k0_break", flat(0x03C4), b'\x33\xff\xe9\x3f\xfe')
chk("case255_pkey_load", flat(0x03C9), b'\x8b\x1e\xda\x29')
chk("case255_sub_59", flat(0x03CD), b'\x83\xeb\x3b')
chk("case255_cmp_9", flat(0x03D0), b'\x83\xfb\x09')
chk("case255_ja_default", flat(0x03D3), b'\x0f\x87\x31\xfe')
chk("case255_jmp_table", flat(0x03D7), b'\x03\xdb\x2e\xff\xa7\x02\x04')
chk("kb_F1_dlgcfg", flat(0x03DE), b'\x90\x0e\xe8\x27\x06')
chk("kb_F1_break", flat(0x03E3), b'\xe9\x22\xfe')
chk("kb_F2_dlged", flat(0x03E6), b'\x90\x0e\xe8\x71\x20')
chk("kb_F2_break", flat(0x03EB), b'\xe9\x1a\xfe')
chk("kb_F4_dlgload", flat(0x03EE), b'\x90\x0e\xe8\xbc\x36')
chk("kb_F4_break", flat(0x03F3), b'\xe9\x12\xfe')
chk("kb_F5_dlgstart", flat(0x03F6), b'\x90\x0e\xe8\x13\x3b')
chk("kb_F5_break", flat(0x03FB), b'\xe9\x0a\xfe')
chk("main_epilogue", flat(0x03FE), b'\x5f\x5e\xc9\xcb')
chk("switch_vals_0_1", flat(0x0416), b'\x00\x00\x01\x00')
chk("switch_vals_2_3", flat(0x041A), b'\x02\x00\x03\x00')
chk("switch_vals_4_5", flat(0x041E), b'\x04\x00\x05\x00')
chk("switch_vals_6_255", flat(0x0422), b'\x06\x00\xff\x00')
chk("switch_jmp_case0", flat(0x0426), b'\x5d\x02')
chk("switch_jmp_case1", flat(0x0428), b'\xde\x03')
chk("switch_jmp_case2", flat(0x042A), b'\xe6\x03')
chk("switch_jmp_case3", flat(0x042C), b'\x73\x02')
chk("switch_jmp_case4", flat(0x042E), b'\x89\x03')
chk("switch_jmp_case5", flat(0x0430), b'\xf6\x03')
chk("switch_jmp_case6", flat(0x0432), b'\x91\x03')
chk("switch_jmp_case255", flat(0x0434), b'\xc9\x03')
chk("pkey_jmp_F1", flat(0x0402), b'\xde\x03')
chk("pkey_jmp_F2", flat(0x0404), b'\xe6\x03')
chk("pkey_jmp_F3", flat(0x0406), b'\x73\x02')
chk("pkey_jmp_F4", flat(0x0408), b'\xee\x03')
chk("pkey_jmp_F5", flat(0x040A), b'\xf6\x03')
chk("pkey_jmp_F6_removed", flat(0x040C), b'\x08\x02')
chk("pkey_jmp_F7_removed", flat(0x040E), b'\x08\x02')
chk("pkey_jmp_F8_noop", flat(0x0410), b'\x08\x02')
chk("pkey_jmp_F9", flat(0x0412), b'\x5d\x02')
chk("pkey_jmp_F10", flat(0x0414), b'\x91\x03')

# ═════════════════════════════════════════════════════════════════════
#  PROJ5.CPP — mainscr() at seg+0x43AC  + show_reit() at seg+0x4827
# ═════════════════════════════════════════════════════════════════════
section("mainscr() + show_reit()")
chk("mainscr_enter", flat(0x43AC), b'\xc8\x26\x00\x00')
chk("mainscr_push_si_di", flat(0x43B0), b'\x56\x57')
chk("test_all_xl", flat(0x43B2), b'\x8b\x7e\x06\x0b\xff')
chk("xl_0", flat(0x43B9), b'\x33\xc0')
chk("xl_144", flat(0x43BD), b'\xb8\x90\x00')
chk("xr_639", flat(0x43C7), b'\xb8\x7f\x02')
chk("xr_464", flat(0x43CC), b'\xb8\xd0\x01')
chk("loop1_cmp_20", flat(0x4411), b'\x83\xfe\x14')
chk("loop2_cmp_10", flat(0x444C), b'\x83\xfe\x0a')
chk_p8("push_BLUE", 0x4451, 1)
chk_lcall("setcolor_BLUE", 0x4453, 0x1D5C, 0x13F1)
chk_str("str_ILT", 0x12C4, b"Institute for Laser Technologies")
chk_str("str_andEng", 0x12E5, b"and Engineering")
chk_p16("ILT_str_off", 0x445A, 0x12C4)
chk_p16("ILT_y310", 0x445D, 0x136)
chk("ILT_x170", flat(0x4460), b'\x68\xaa\x00')
chk_p16("andEng_str", 0x446C, 0x12E5)
chk_p16("andEng_y320", 0x446F, 0x140)
chk("if_all_je", flat(0x447F), b'\x0f\x84\x5a\x03')
chk("push_BLUE_1_fstyle", flat(0x4483), b'\x6a\x01\x6a\x01')
chk_lcall("setfillstyle_1_BLUE", 0x4487, 0x1211, 0x13F1)
chk("bar_loop_cmp_7", flat(0x44D3), b'\x83\xfe\x07')
chk("call_drawfl", flat(0x44D9), b'\x0e\xe8\x6d\x05')
chk_p8("draw_bt_BNM_7", 0x44DD, 7)
chk("call_htime", flat(0x44F4), b'\x90\x0e\xe8\xb5\x1b')
chk_p8("push_9_setcolor", 0x44FC, 9)
chk_lcall("setcolor_9", 0x44FE, 0x1D5C, 0x13F1)
chk_str("str_277", 0x0090, b"2.77")
chk("push_ds_277", flat(0x4504), b'\x1e')
chk_p16("push_0090_277str", 0x4505, 0x0090)
chk_p8("push_55_y", 0x4508, 0x37)
chk_p16("push_580_x", 0x450A, 0x244)
chk_lcall("outtextxy_277", 0x450D, 0x1F2A, 0x13F1)
chk_p8("push_COLBKL_59", 0x4515, 0x3B)
chk_lcall("setcolor_COLBKL", 0x4517, 0x1D5C, 0x13F1)
chk("cmp_tout_0", flat(0x451D), b'\x83\x3e\xdc\x29\x00')
chk("je_skip_tout", flat(0x4522), b'\x74\x12')
chk("tout_y235", flat(0x4529), b'\x68\xeb\x00')
chk_p8("tout_x20", 0x452C, 0x14)
chk_str("str_1", 0x12F5, b"1")
chk_p8("ctlbt1_x30", 0x453E, 0x1E)
chk_str("str_9", 0x12F7, b"9")
chk_p8("ctlbt2_y70", 0x454D, 0x46)
chk_str("str_Drcheck", 0x12F9, b"Dr.check")
chk_p8("ctlbt3_x30", 0x4561, 0x1E)
chk("ctlbt3_y145", flat(0x455E), b'\x68\x91\x00')
chk_p8("push_COL_ON_60", 0x456A, 0x3C)
chk_p8("push_1_fill", 0x456C, 0x01)
chk("cmp_gl_nmb", flat(0x4576), b'\x83\x3e\xb6\x29\x00')
chk("bar_31_71_39_79", flat(0x457D), b'\x6a\x4f\x6a\x27\x6a\x47\x6a\x1f')
chk("cmp_d_check", flat(0x45AF), b'\x83\x3e\xce\x29\x00')
chk("je_skip_dcheck", flat(0x45B4), b'\x74\x12')
chk("bar_dcheck", flat(0x45B6), b'\x68\x9a\x00\x6a\x27\x68\x92\x00\x6a\x1f')
chk_str("str_File", 0x1302, b"File:")
chk_p8("File_y30", 0x45CC, 0x1E)
chk_p8("File_x20", 0x45CE, 0x14)
chk_str("str_Nmax", 0x1308, b"Nmax:")
chk("Nmax_y175", flat(0x45EC), b'\x68\xaf\x00')
chk_p8("Nmax_x20", 0x45EF, 0x14)
chk("Nmax_val_y175", flat(0x4612), b'\x68\xaf\x00')
chk_p8("Nmax_val_x65", 0x4615, 0x41)
chk_str("str_Nlast", 0x130E, b"Nlast:")
chk("Nlast_y194", flat(0x4623), b'\x68\xc2\x00')
chk_p8("Nlast_x20", 0x4626, 0x14)
chk_str("str_GLASS", 0x1315, b"GLASS:")
chk_p16("GLASS_y270", 0x4634, 0x10E)
chk_p8("GLASS_x30", 0x4637, 0x1E)
chk_str("str_n", 0x131C, b"n:")
chk_p16("n_y285", 0x4645, 0x11D)
chk_p16("n_val_y285", 0x4674, 0x11D)
chk_p8("n_val_x50", 0x4677, 0x32)
chk_str("str_X", 0x131F, b"X:")
chk_p16("X_y300", 0x4685, 0x12C)
chk_p16("X_val_y300", 0x46BE, 0x12C)
chk_str("str_Y", 0x1322, b"Y:")
chk_p16("Y_y313", 0x46CF, 0x139)
chk_p16("Y_val_y313", 0x4708, 0x139)
chk_str("str_Z", 0x1325, b"Z:")
chk_p16("Z_y326", 0x4719, 0x146)
chk_p16("Z_val_y326", 0x4752, 0x146)
chk_p16("rect_y2_344", 0x475F, 0x158)
chk_p8("rect_x2_96", 0x4762, 0x60)
chk_p16("rect_y1_260", 0x4764, 0x104)
chk_p8("rect_x1_20", 0x4767, 0x14)
chk_lcall("rect_call", 0x4769, 0x119E, 0x13F1)
chk("cmp_f_demo", flat(0x4771), b'\x83\x3e\x60\x29\x00')
chk("je_skip_demo", flat(0x4776), b'\x74\x19')
chk_p8("push_COL_ON_demo", 0x4778, 0x3C)
chk_lcall("setcolor_COL_ON", 0x477A, 0x1D5C, 0x13F1)
chk_str("str_Demo", 0x1328, b"Demo")
chk_p8("Demo_y85", 0x4784, 0x55)
chk_p16("Demo_x565", 0x4786, 0x235)
chk_p8("push_BLACK", 0x4791, 0x00)
chk_lcall("setcolor_BLACK", 0x4793, 0x1D5C, 0x13F1)
chk_p8("push_COLBKL_fill", 0x4799, 0x3B)
chk_p8("push_1_fill2", 0x479B, 0x01)
chk("bar_nlast_y2_222", flat(0x47A5), b'\x68\xde\x00')
chk_p8("bar_nlast_x2_86", 0x47A8, 0x56)
chk("bar_nlast_y1_206", flat(0x47AA), b'\x68\xce\x00')
chk_p8("bar_nlast_x1_31", 0x47AD, 0x1F)
chk("lastn_y211", flat(0x47D0), b'\x68\xd3\x00')
chk_p8("lastn_x40", 0x47D3, 0x28)
chk_p8("outside_COLBKL", 0x47DD, 0x3B)
chk_p8("outside_wrkfile_y30", 0x47E9, 0x1E)
chk_p8("outside_wrkfile_x65", 0x47EB, 0x41)
chk_str("str_Reit", 0x132D, b"Reiterations:")
chk_p16("Reit_y386", 0x47F9, 0x182)
chk_p8("Reit_x20", 0x47FC, 0x14)
chk("push_0_showreit", flat(0x4806), b'\x6a\x00')
chk("call_showreit", flat(0x4808), b'\x90\x0e\xe8\x1a\x00')
chk("cmp_f_data", flat(0x480E), b'\x83\x3e\x78\x29\x00')
chk("mainscr_epilogue", flat(0x4823), b'\x5f\x5e\xc9\xcb')
# show_reit()
chk("showreit_enter", flat(0x4827), b'\xc8\x0e\x00\x00')
chk("showreit_push_si_di", flat(0x482B), b'\x56\x57')
chk_p8("sr_push_COLBKL", 0x482D, 0x3B)
chk_lcall("sr_setcolor_COLBKL", 0x482F, 0x1D5C, 0x13F1)
chk_p8("sr_push_BLACK", 0x4835, 0x00)
chk_p8("sr_push_1_fill", 0x4837, 0x01)
chk_lcall("sr_setfillstyle", 0x4839, 0x1211, 0x13F1)
chk("sr_cmp_glnmb", flat(0x4841), b'\x83\x3e\xb6\x29\x00')
chk("sr_je_single", flat(0x4846), b'\x0f\x84\xe2\x00')
chk("sr_mask_init", flat(0x484A), b'\xc7\x46\xfc\x01\x00')
chk("sr_xor_si", flat(0x484F), b'\x33\xf6')
chk("sr_loop_si_cmp", flat(0x4923), b'\x83\xfe\x03')
chk("sr_loop_di_cmp", flat(0x491B), b'\x83\xff\x03')
chk("sr_rect_y1_base", flat(0x4858), b'\x05\xa2\x01')
chk("sr_rect_x2_base", flat(0x4864), b'\x05\x32\x00')
chk("sr_rect_y1_start", flat(0x486D), b'\x05\x94\x01')
chk("sr_rect_x1_base", flat(0x4874), b'\x05\x0a\x00')
chk_lcall("sr_rect_call", 0x4878, 0x119E, 0x13F1)
chk("sr_cmp_mode", flat(0x4880), b'\x83\x7e\x06\x00')
chk("sr_je_skip_mode", flat(0x4884), b'\x74\x20')
chk("sr_color_COL_ON", flat(0x488F), b'\xb8\x3c\x00')
chk("sr_bar_y2_base", flat(0x48AB), b'\x05\xa1\x01')
chk("sr_bar_x2_base", flat(0x48B7), b'\x05\x31\x00')
chk("sr_bar_y1_base", flat(0x48C0), b'\x05\x95\x01')
chk("sr_bar_x1_base", flat(0x48C7), b'\x05\x0b\x00')
chk_lcall("sr_bar_call", 0x48CB, 0x1C32, 0x13F1)
chk("sr_test_glpos9", flat(0x48D6), b'\x85\x06\xb8\x29')
chk("sr_itoa_nmrpt", flat(0x48EC), b'\xff\xb7\xba\x29')
chk("sr_text_y_base", flat(0x4902), b'\x05\x98\x01')
chk("sr_text_x_base", flat(0x490B), b'\x05\x0e\x00')
chk("sr_mask_shl", flat(0x4917), b'\xd1\x66\xfc')
chk("sr_single_rect", flat(0x492C), b'\x68\xa2\x01\x6a\x3c\x68\x94\x01\x6a\x14')
chk("sr_single_bar", flat(0x493E), b'\x68\xa1\x01\x6a\x3b\x68\x95\x01\x6a\x15')
chk("sr_single_nmrpt", flat(0x4957), b'\xff\x36\xcc\x29')
chk_p16("sr_single_y408", 0x4968, 0x198)
chk_p8("sr_single_x24", 0x496B, 0x18)
chk("sr_epilogue", flat(0x4975), b'\x5f\x5e\xc9\xcb')

# ═════════════════════════════════════════════════════════════════════
#  PROJ5.CPP — dlgstart() at seg+0x3F0D  + inp_dig() at seg+0x38FA
# ═════════════════════════════════════════════════════════════════════
section("dlgstart() + inp_dig()")
chk("dlgstart_prologue", flat(0x3F0D), b'\x3e\xc8\x34\x00\x00')
chk("push_si_di", flat(0x3F12), b'\x56\x57')
chk("st_nmbnew_lastn", flat(0x3F14), b'\x66\xa1\x80\x29\x66\x89\x46\xea')
chk("f_start_2", flat(0x3F1C), b'\xbe\x02\x00')
chk("WndBkgr_COLDLG3", flat(0x3F23), b'\x6a\x03')
chk("WndBkgr_y2_400", flat(0x3F25), b'\x68\x90\x01')
chk("WndBkgr_x2_520", flat(0x3F28), b'\x68\x08\x02')
chk("WndBkgr_y1_100", flat(0x3F2B), b'\x6a\x64')
chk("WndBkgr_x1_100", flat(0x3F2D), b'\x6a\x64')
chk("draw_bt_BNM14", flat(0x3F36), b'\x6a\x0e')
chk("line1_y2_212", flat(0x3F48), b'\x68\xd4\x00')
chk("line1_x2_517", flat(0x3F4B), b'\x68\x05\x02')
chk("line1_y1_212", flat(0x3F4E), b'\x68\xd4\x00')
chk("line1_x1_103", flat(0x3F51), b'\x6a\x67')
chk("line1_lcall", flat(0x3F53), b'\x9a\xcf\x1b\xf1\x13')
chk("line2_y2_156", flat(0x3F5B), b'\x68\x9c\x00')
chk("line2_x2_275", flat(0x3F5E), b'\x68\x13\x01')
chk("line2_y1_156", flat(0x3F61), b'\x68\x9c\x00')
chk("line2_x1_236", flat(0x3F64), b'\x68\xec\x00')
chk("line2_lcall", flat(0x3F67), b'\x9a\xcf\x1b\xf1\x13')
chk("line2_sp_8", flat(0x3F6C), b'\x83\xc4\x08')
chk("outtxt_push_ds", flat(0x3F6F), b'\x1e')
chk("outtxt_str_126E", flat(0x3F70), b'\x68\x6e\x12')
chk("outtxt_y281", flat(0x3F73), b'\x68\x19\x01')
chk("outtxt_x120", flat(0x3F76), b'\x6a\x78')
chk("outtxt_lcall", flat(0x3F78), b'\x9a\x2a\x1f\xf1\x13')
chk("rect1_y2_164", flat(0x3F80), b'\x68\xa4\x00')
chk("rect1_x2_340", flat(0x3F83), b'\x68\x54\x01')
chk("rect1_y1_148", flat(0x3F86), b'\x68\x94\x00')
chk("rect1_x1_280", flat(0x3F89), b'\x68\x18\x01')
chk("rect1_lcall", flat(0x3F8C), b'\x9a\x9e\x11\xf1\x13')
chk("rect2_y2_360", flat(0x3F94), b'\x68\x68\x01')
chk("rect2_x2_380", flat(0x3F97), b'\x68\x7c\x01')
chk("rect2_y1_291", flat(0x3F9A), b'\x68\x23\x01')
chk("rect2_x1_120", flat(0x3F9D), b'\x6a\x78')
# sw_ctl calls (9 switches with COLDLG=3)
for off in [0x3FA7, 0x3FB8, 0x3FC9, 0x3FDA, 0x3FEB, 0x3FFF, 0x4013, 0x4028, 0x403D]:
    chk(f"sw_ctl_COLDLG_{off:04X}", flat(off), b'\x6a\x03')
# Case 0
chk("nmb_pbt_255", flat(0x411C), b'\xc7\x06\xd8\x29\xff\x00')
chk("or_si_si", flat(0x4122), b'\x0b\xf6')
chk("jne_skip_ClearRpt", flat(0x4124), b'\x75\x05')
chk("ClearRpt_nop_cs", flat(0x4126), b'\x90\x0e')
_cr = exe[flat(0x4128):flat(0x412B)]
chk_val("ClearRpt_call_e8", _cr[0] == 0xe8)
chk_val("ClearRpt_target_4395", 0x412B + struct.unpack_from('<h', _cr, 1)[0] == 0x4395)
chk("mainscr_push_1", flat(0x412B), b'\x6a\x01')
chk("mainscr_nop_cs", flat(0x412D), b'\x90\x0e')
_ms = exe[flat(0x412F):flat(0x4132)]
chk_val("mainscr_call_e8", _ms[0] == 0xe8)
chk_val("mainscr_target_43AC", 0x4132 + struct.unpack_from('<h', _ms, 1)[0] == 0x43AC)
chk("outportb_ADRCMOS", flat(0x4140), b'\xba\x18\x03\xb0\x00')
chk("ADRPPI2_30A", flat(0x4146), b'\xba\x0a\x03')
chk("STEP_ON_and_FE", flat(0x414A), b'\x24\xfe')
chk("delay_30", flat(0x4150), b'\x6a\x1e')
chk("process_lcall", flat(0x4158), b'\x9a\xac\x02\x5c\x11')
chk("no_ClearRpt_mid", flat(0x4157), b'\x59\x9a')
chk("STEP_OFF_or_01", flat(0x4164), b'\x0c\x01')
chk("FlashWr_lcall", flat(0x416A), b'\x9a\x04\x04\x29\x12')
# Cases 2-12
chk("case2_cmp_si1", flat(0x41F6), b'\x83\xfe\x01')
chk("case2_cmp_nmax0", flat(0x41FD), b'\x66\x83\x3e\x84\x29\x00')
chk("case3_cmp_si1", flat(0x4225), b'\x83\xfe\x01')
chk("case3_cmp_nmax0", flat(0x422C), b'\x66\x83\x3e\x84\x29\x00')
chk("case4_f_start0", flat(0x424B), b'\x33\xf6')
chk("case5_f_start1", flat(0x4258), b'\xbe\x01\x00')
chk("case6_f_start2", flat(0x425E), b'\xbe\x02\x00')
chk("case7_f_start3", flat(0x426C), b'\xbe\x03\x00')
chk("case7_port_31A", flat(0x426F), b'\xba\x1a\x03')
chk("case7_port_31B", flat(0x4277), b'\xba\x1b\x03')
chk("case8_f_ptr", flat(0x4291), b'\x83\x3e\x70\x29\x00')
chk("case9_d_check", flat(0x42A5), b'\x83\x3e\xce\x29\x00')
chk("case10_f_noise2", flat(0x42C8), b'\xc7\x06\xd0\x29\x02\x00')
chk("case11_f_noise1", flat(0x42D1), b'\xc7\x06\xd0\x29\x01\x00')
chk("case12_f_noise0", flat(0x42DA), b'\xc7\x06\xd0\x29\x00\x00')
# Case 13 — inp_dig
chk("case13_cmp_si1", flat(0x42E3), b'\x83\xfe\x01')
chk("case13_jne", flat(0x42E6), b'\x0f\x85')
chk("case13_cmp_nmax0", flat(0x42EA), b'\x66\x83\x3e\x84\x29\x00')
chk("case13_je", flat(0x42F0), b'\x0f\x84')
chk("case13_push_3", flat(0x42F4), b'\x6a\x03')
chk("case13_mov_nmax", flat(0x42F6), b'\x66\xa1\x84\x29')
chk("case13_push_yt149", flat(0x4315), b'\x68\x95\x00')
chk("case13_push_xl281", flat(0x4318), b'\x68\x19\x01')
chk("case13_push_cs", flat(0x431D), b'\x0e')
_c13 = exe[flat(0x431E):flat(0x4321)]
chk_val("case13_call_e8", _c13[0] == 0xe8)
chk_val("case13_target_38FA", 0x4321 + struct.unpack_from('<h', _c13, 1)[0] == 0x38FA)
chk("case13_sp22", flat(0x4321), b'\x83\xc4\x16')
chk("case13_cmp_result", flat(0x432A), b'\x66\x83\x7e\xee\x00')
chk("case13_jle_break", flat(0x432F), b'\x0f\x8e')
chk("case13_load_result", flat(0x4333), b'\x66\x8b\x46\xee')
chk("case13_dec_eax", flat(0x4337), b'\x66\x48')
chk("case13_store_nmbnew", flat(0x4339), b'\x66\x89\x46\xea')
# Case 255
chk("case255_cmp_13", flat(0x4340), b'\x83\x3e\xda\x29\x0d')
chk("case255_je_case0", flat(0x4345), b'\x0f\x84\x92\xfd')
chk("case255_cmp_27", flat(0x4349), b'\x83\x3e\xda\x29\x1b')
chk("case255_jne_loop", flat(0x434E), b'\x0f\x85\x55\xfc')
chk("case255_jmp_cancel", flat(0x4352), b'\xe9\x96\xfe')
chk("dlgstart_epilogue", flat(0x4355), b'\x5f\x5e\xc9\xcb')
chk_val("dlgstart_size_1100", 0x4358 - 0x3F0D + 1 == 1100)
# inp_dig() at seg+0x38FA
chk("inp_dig_enter", flat(0x38FA), b'\xc8\x10\x00\x00')
chk("inp_dig_push_si_di", flat(0x38FE), b'\x56\x57')
chk("inp_dig_str0_5f", flat(0x3900), b'\xc6\x46\xf0\x5f')
chk("inp_dig_mov_cx3", flat(0x3904), b'\xb9\x03\x00')
chk("inp_dig_si_init", flat(0x3911), b'\xbe\x07\x00\x33\xf6')
chk("inp_dig_setcolor0", flat(0x3916), b'\x6a\x00\x9a\x5c\x1d\xf1\x13')
chk("inp_dig_yt14", flat(0x392D), b'\x05\x0e\x00')
chk("inp_dig_xl58", flat(0x3934), b'\x05\x3a\x00')
chk("inp_dig_yt4", flat(0x394E), b'\x05\x04\x00')
chk("inp_dig_xl9", flat(0x3955), b'\x05\x09\x00')
chk("inp_dig_kbhit", flat(0x3961), b'\x9a\x53\x19\x00\x00')
chk("inp_dig_or_ax", flat(0x3966), b'\x0b\xc0')
chk("inp_dig_je_kbhit", flat(0x3968), b'\x74\xf7')
chk_val("inp_dig_no_out_time", exe[flat(0x395E):flat(0x3961)] != b'\x6a\x01\x9a')
chk("inp_dig_cmp_2f", flat(0x3976), b'\x3d\x2f\x00')
chk("inp_dig_cmp_3a", flat(0x397F), b'\x3d\x3a\x00')
chk("inp_dig_cmp_2e", flat(0x3988), b'\x3d\x2e\x00')
chk("inp_dig_s_lt5", flat(0x398D), b'\x83\xfe\x05')
chk("inp_dig_cmp_BS", flat(0x39A1), b'\x3d\x08\x00')
chk("inp_dig_ESC_dx_ffff", flat(0x39BC), b'\xba\xff\xff')
chk("inp_dig_ESC_ax_ffff", flat(0x39BF), b'\xb8\xff\xff')
chk("inp_dig_cmp_0d", flat(0x39C9), b'\x3d\x0d\x00')
chk("inp_dig_ax0", flat(0x39FD), b'\x83\x7e\x1a\x00')
chk("inp_dig_ax1", flat(0x3A0E), b'\x83\x7e\x1a\x01')
chk("inp_dig_ax2", flat(0x3A23), b'\x83\x7e\x1a\x02')
chk("inp_dig_ax2_skip_mul", flat(0x3A27), b'\x75\x0f')
chk("inp_dig_nglas_29A2", flat(0x3A08), b'\xdd\x1e\xa2\x29')
chk("inp_dig_mul10", flat(0x3A15), b'\xd9\x06\xf6\x0f')
chk("inp_dig_mul100", flat(0x3A2A), b'\xd9\x06\x73\x10')
chk("inp_dig_FTOL", flat(0x3A3C), b'\x9a')
chk("inp_dig_msgbox_cs", flat(0x3A4B), b'\x0e')
_md = exe[flat(0x3A4C):flat(0x3A4F)]
chk_val("inp_dig_msgbox_07AB", 0x3A4F + struct.unpack_from('<h', _md, 1)[0] == 0x07AB)
chk("inp_dig_epilogue", flat(0x3A55), b'\x5f\x5e\xc9\xcb')
chk_val("inp_dig_size_351", 0x3A58 - 0x38FA + 1 == 351)

# ═════════════════════════════════════════════════════════════════════
#  PROJ5.CPP — dlged() at seg+0x245C
# ═════════════════════════════════════════════════════════════════════
section("dlged()")
chk("dlged_enter", flat(0x245C), b'\xc8\x50\x00\x00')
chk("dlged_push_si_di", flat(0x2460), b'\x56\x57')
chk("init_nmax_0", flat(0x2462), b'\x66\xc7\x06\x84\x29\x00\x00\x00\x00')
chk("init_f_view", flat(0x246B), b'\xc7\x46\xf0\x00\x00')
chk("init_f_mirror", flat(0x2470), b'\xc7\x46\xee\x00\x00')
chk("init_chpic0", flat(0x2475), b'\xc7\x46\xda\x00\x00')
chk("strcpy_fasc", flat(0x247A), b'\x1e\x68\xbd\x10')
chk("init_f_invert", flat(0x248B), b'\xc7\x46\xec\x00\x00')
chk("init_f_data_0", flat(0x2490), b'\xc7\x06\x78\x29\x00\x00')
chk("label_c_xofs", flat(0x2496), b'\xc7\x06\xb0\x29\x00\x00')
chk("label_c_yofs", flat(0x249C), b'\xc7\x06\xb2\x29\x00\x00')
chk("label_c_zofs", flat(0x24A2), b'\xc7\x06\xb4\x29\x00\x00')
chk("wndbkgr_str", flat(0x24A8), b'\x1e\x68\xbe\x10')
chk("wndbkgr_coldlg3", flat(0x24AC), b'\x6a\x03')
chk("wndbkgr_462", flat(0x24AE), b'\x68\xce\x01')
chk("wndbkgr_610", flat(0x24B1), b'\x68\x62\x02')
chk("wndbkgr_20", flat(0x24B4), b'\x6a\x14')
chk("wndbkgr_80", flat(0x24B6), b'\x6a\x50')
chk("call_WndBkgr", flat(0x24B8), b'\x0e\xe8\x8c\xe4')
chk("draw_bt_31", flat(0x24BF), b'\x6a\x1f')
chk("call_draw_bt", flat(0x24C9), b'\x90\x0e\xe8\xfb\x2a')
chk("outtxt_file_90", flat(0x24D7), b'\x6a\x5a')
chk("outtxt_file_45", flat(0x24D5), b'\x6a\x2d')
chk("outtxt_glass_500", flat(0x24F9), b'\x68\xf4\x01')
chk("outtxt_glass_44", flat(0x24F7), b'\x6a\x2c')
chk("rect_glass_call", flat(0x250E), b'\x9a\x9e\x11\xf1\x13')
chk("sw_ctl_chpic0", flat(0x2641), b'\x83\x7e\xda\x00')
chk("call_minmax", flat(0x2699), b'\xe8\x97\x33')
chk("fview_switch_ref", flat(0x26A6), b'\x03\xdb\x2e\xff\xa7\xc7\x38')
chk("f_data_check", flat(0x2A13), b'\x83\x3e\x78\x29\x00')
chk("scan_ms_fbeep0", flat(0x2D44), b'\x6a\x00')
chk("scan_ms_BNM_ED", flat(0x2D46), b'\x6a\x1f')
chk("scan_ms_bnam", flat(0x2D48), b'\x1e\x68\x66\x04')
chk("scan_ms_btc", flat(0x2D4C), b'\x1e\x68\xe2\x04')
chk("call_scan_ms", flat(0x2D50), b'\x90\x0e\xe8\x6b\x30')
chk("switch_cx_32", flat(0x2D61), b'\xb9\x20\x00')
chk("switch_tbl_ref", flat(0x2D64), b'\xbb\x3f\x38')
chk("switch_loop", flat(0x2D67), b'\x2e\x8b\x07\x3b\x46\xd2\x74\x08\x83\xc3\x02\xe2\xf3')
chk("switch_default", flat(0x2D74), b'\xe9\xca\xf8')
chk("switch_dispatch", flat(0x2D77), b'\x2e\xff\x67\x40')
chk("case0_nmax_0", flat(0x2D7B), b'\x66\xc7\x06\x84\x29\x00\x00\x00\x00')
chk("case0_lastn_0", flat(0x2D84), b'\x66\xc7\x06\x80\x29\x00\x00\x00\x00')
chk("case0_f_data_0", flat(0x2D8D), b'\xc7\x06\x78\x29\x00\x00')
chk("case1_push1", flat(0x2DB4), b'\x6a\x01')
chk("case1_dlgopen", flat(0x2DBE), b'\x0e\xe8\x8c\xeb')
chk("case1_f_bca_ne2", flat(0x2F38), b'\x83\x3e\x64\x29\x02')
chk("case1_wrt_bft", flat(0x2FD1), b'\x9a\x02\x15\x29\x12')
chk("case1_wrt_cft", flat(0x2FE5), b'\x9a\xce\x10\x29\x12')
chk("case1_wrasc", flat(0x30A9), b'\x9a\x88\x0d\x29\x12')
chk("case1_chdiska", flat(0x30B3), b'\xe8\x19\x08')
chk("case1_tout_1", flat(0x30CB), b'\xc7\x06\xdc\x29\x01\x00')
chk("case2_f_bcab_2", flat(0x3125), b'\x83\x3e\x62\x29\x02')
chk("case2_rdbft_t", flat(0x3185), b'\x9a\xf8\x15\x29\x12')
chk("case2_rdcft_t", flat(0x3198), b'\x9a\x7d\x07\x29\x12')
chk("case2_rdbmp", flat(0x31A4), b'\x9a\x02\x17\x29\x12')
chk("case2_nmax_check", flat(0x31C6), b'\x66\x83\x3e\x84\x29\x00')
chk("case2_f_bcab_3", flat(0x31CE), b'\x83\x3e\x62\x29\x03')
chk("case3_fview_cmp", flat(0x32E9), b'\x83\x7e\xf0\x02')
chk("case3_fview_jle", flat(0x32ED), b'\x7e\x04')
chk("case3_fview_reset", flat(0x32EF), b'\x33\xc0\xeb\x06')
chk("case3_fview_inc", flat(0x32F3), b'\xff\x46\xf0')
chk("case4_f_mirror", flat(0x32FF), b'\x83\x7e\xee\x00')
chk("case5_InrDcr", flat(0x333F), b'\xe8\x83\xe5')
chk("case6_InrDcr", flat(0x336C), b'\xe8\x56\xe5')
chk("case7_InrDcr", flat(0x3387), b'\xe8\x3b\xe5')
chk("case8_InrDcr", flat(0x33A9), b'\xe8\x19\xe5')
chk("case9_10_strcpy", flat(0x34D2), b'\x9a\xec\x1b\x00\x00')
chk("case11_InrDcr", flat(0x34E8), b'\xe8\xda\xe3')
chk("case12_InrDcr", flat(0x3502), b'\xe8\xc0\xe3')
chk("case13_InrDcr", flat(0x351C), b'\xe8\xa6\xe3')
chk("case14_InrDcr", flat(0x3536), b'\xe8\x8c\xe3')
chk("case15_InrDcr", flat(0x3554), b'\xe8\x6e\xe3')
chk("case17_dlgsort", flat(0x3562), b'\xe8\xf8\x1a')
chk("case18_ax0", flat(0x3568), b'\x6a\x00')
chk("case18_y86", flat(0x3582), b'\x6a\x56')
chk("case18_x501", flat(0x3584), b'\x68\xf5\x01')
chk("case18_inp_dig", flat(0x358B), b'\xe8\x6c\x03')
chk("case18_long_ret", flat(0x358E), b'\x52\x50\x66\x58')
chk("case18_cmp_eax", flat(0x3595), b'\x66\x83\xf8\x00')
chk("case18_jle", flat(0x3599), b'\x0f\x8e\xa4\xf0')
chk("case19_ax1", flat(0x35A4), b'\x6a\x01')
chk("case19_y122", flat(0x35BE), b'\x6a\x7a')
chk("case19_x501", flat(0x35C0), b'\x68\xf5\x01')
chk("case19_inp_dig", flat(0x35C7), b'\xe8\x30\x03')
chk("case19_k_trunc", flat(0x35CD), b'\x8b\xf8')
chk("case19_k_check", flat(0x35CF), b'\x0b\xff\x0f\x8e\x6c\xf0')
chk("case19_xsize_store", flat(0x35D5), b'\x89\x3e\xaa\x29')
chk("case20_ax1", flat(0x35DC), b'\x6a\x01')
chk("case20_y158", flat(0x35F6), b'\x68\x9e\x00')
chk("case20_inp_dig", flat(0x3600), b'\xe8\xf7\x02')
chk("case20_ysize", flat(0x360E), b'\x89\x3e\xac\x29')
chk("case21_ax1", flat(0x3615), b'\x6a\x01')
chk("case21_y194", flat(0x362F), b'\x68\xc2\x00')
chk("case21_inp_dig", flat(0x3639), b'\xe8\xbe\x02')
chk("case21_zsize", flat(0x3647), b'\x89\x3e\xae\x29')
chk("case22_gselect", flat(0x364E), b'\x90\x0e\xe8\x74\x05')
chk("case25_minmax", flat(0x3673), b'\xe8\xbd\x23')
chk("case27_ax2", flat(0x36F4), b'\x6a\x02')
chk("case27_y275", flat(0x370E), b'\x68\x13\x01')
chk("case27_x528", flat(0x3711), b'\x68\x10\x02')
chk("case27_inp_dig", flat(0x3718), b'\xe8\xdf\x01')
chk("case27_k_trunc", flat(0x371E), b'\x8b\xf8')
chk("case27_k_check", flat(0x3720), b'\x0b\xff\x7c\x0e')
chk("case27_calc", flat(0x3724), b'\x8b\x46\xe4\x6b\xc0\x0a\x2b\x46\xdc\x2b\xc7')
chk("label_l_fview0", flat(0x3732), b'\x83\x7e\xf0\x00')
chk("label_l_yofs", flat(0x3738), b'\x8b\x46\xe8\xa3\xb2\x29')
chk("case28_ax2", flat(0x3759), b'\x6a\x02')
chk("case28_y293", flat(0x3773), b'\x68\x25\x01')
chk("case28_x528", flat(0x3776), b'\x68\x10\x02')
chk("case28_inp_dig", flat(0x377D), b'\xe8\x7a\x01')
chk("case255_esc", flat(0x3826), b'\x83\x3e\xda\x29\x1b')
chk("case255_esc_je", flat(0x382B), b'\x0f\x84\x4c\xf5')
chk("case255_f9", flat(0x382F), b'\x83\x3e\xda\x29\x43')
chk("case255_f9_jne", flat(0x3834), b'\x0f\x85\x09\xee')
chk("case255_f9_jmp", flat(0x3838), b'\xe9\xae\xfa')
chk("dlged_epilogue", flat(0x383B), b'\x5f\x5e\xc9\xcb')
chk("dlged_switch_vals", flat(0x383F), b'\x00\x00\x01\x00\x02\x00\x03\x00')
chk("dlged_switch_end", flat(0x3879), b'\x1d\x00\x1e\x00\xff\x00')
chk("dlged_jmp_case0", flat(0x387F), b'\x7b\x2d')
chk("dlged_jmp_case1", flat(0x3881), b'\xb4\x2d')
chk("dlged_jmp_case2", flat(0x3883), b'\xdf\x30')
chk("dlged_jmp_case3", flat(0x3885), b'\xe9\x32')
chk("dlged_jmp_case255", flat(0x38BD), b'\x26\x38')

# ═════════════════════════════════════════════════════════════════════
#  PROJ5.CPP — remaining functions (202 checks)
# ═════════════════════════════════════════════════════════════════════
section("Remaining PROJ5 functions")
# button (0x0436)
chk("button_enter", flat(0x0436), b'\xc8\x12\x00\x00')
chk("button_push_si_di", flat(0x043A), b'\x56\x57')
chk_p8("button_fill_63", 0x043F, 0x3F)
chk_p8("button_fill_1a", 0x0441, 0x01)
chk_lcall("button_setfillstyle1", 0x0443, 0x1211, 0x13F1)
chk_p8("button_fill_0", 0x049C, 0x00)
chk_p8("button_fill_1b", 0x049E, 0x01)
chk_lcall("button_setfillstyle2", 0x04A0, 0x1211, 0x13F1)
chk_p8("button_fill_7", 0x0509, 0x07)
chk_p8("button_fill_1c", 0x050B, 0x01)
chk_lcall("button_setfillstyle3", 0x050D, 0x1211, 0x13F1)
chk_p8("button_setcolor_0", 0x0574, 0x00)
chk_lcall("button_setcolor", 0x0576, 0x1D5C, 0x13F1)
chk("button_y_add4", flat(0x0597), b'\x05\x04\x00')
chk("button_x_add4", flat(0x05AB), b'\x05\x04\x00')
chk_lcall("button_outtextxy", 0x05AF, 0x1F2A, 0x13F1)
chk("button_epilogue", flat(0x05B7), b'\x5f\x5e\xc9\xcb')
# buttonp (0x05BB)
chk("buttonp_enter", flat(0x05BB), b'\xc8\x0c\x00\x00')
chk_p8("buttonp_fill_0", 0x05C4, 0x00)
chk_lcall("buttonp_setfillstyle1", 0x05C8, 0x1211, 0x13F1)
chk_p8("buttonp_fill_7", 0x0621, 0x07)
chk_lcall("buttonp_setfillstyle2", 0x0625, 0x1211, 0x13F1)
chk_p8("buttonp_setcolor", 0x068E, 0x00)
chk_lcall("buttonp_setcolor_call", 0x0690, 0x1D5C, 0x13F1)
chk("buttonp_y_add5", flat(0x06B1), b'\x05\x05\x00')
chk("buttonp_x_add5", flat(0x06C5), b'\x05\x05\x00')
chk_lcall("buttonp_outtextxy", 0x06C9, 0x1F2A, 0x13F1)
chk("buttonp_epilogue", flat(0x06D1), b'\x5f\x5e\xc9\xcb')
# ctlbt (0x06D5)
chk("ctlbt_prologue", flat(0x06D5), b'\x55\x8b\xec\x56\x57')
chk_lcall("ctlbt_setcolor", 0x06E3, 0x1D5C, 0x13F1)
chk_lcall("ctlbt_rectangle", 0x06F3, 0x119E, 0x13F1)
chk_lcall("ctlbt_outtextxy", 0x0709, 0x1F2A, 0x13F1)
# msgbox (0x07AB)
chk("msgbox_prologue", flat(0x07AB), b'\x55\x8b\xec\x56\x57')
chk_p16("msgbox_gi_x1", 0x07BA, 0x0181)
chk_p16("msgbox_gi_y1", 0x07BD, 0x0122)
chk_p16("msgbox_gi_x2", 0x07C0, 0x00B4)
chk_lcall("msgbox_getimage", 0x07C3, 0x2066, 0x13F1)
chk_p16("msgbox_bar1_yb", 0x07D7, 0x0158)
chk_p16("msgbox_bar1_xr", 0x07DA, 0x0180)
chk_p16("msgbox_bar1_y1", 0x07DD, 0x0126)
chk_p16("msgbox_bar1_x1", 0x07E0, 0x00B8)
chk_lcall("msgbox_bar1", 0x07E3, 0x1C32, 0x13F1)
chk_p8("msgbox_fill_colon", 0x07EB, 0x3C)
chk_p16("msgbox_bar2_yb", 0x07F7, 0x0154)
chk_p16("msgbox_bar2_x1", 0x0800, 0x00B4)
chk_lcall("msgbox_bar2", 0x0803, 0x1C32, 0x13F1)
chk_p16("msgbox_txt_y", 0x0819, 0x0129)
chk_p16("msgbox_txt_x", 0x081C, 0x00BE)
chk_lcall("msgbox_outtextxy1", 0x081F, 0x1F2A, 0x13F1)
chk_str("msgbox_nextpix", 0x0F51, b"Next pix:")
chk_p16("msgbox_np_y", 0x082F, 0x0145)
chk_p16("msgbox_np_x", 0x0832, 0x00BE)
chk_lcall("msgbox_outtextxy2", 0x0835, 0x1F2A, 0x13F1)
chk_lcall("msgbox_putimage", 0x0876, 0x1526, 0x13F1)
chk("msgbox_ret2", flat(0x088C), b'\xb8\x02\x00')
chk("msgbox_ret1", flat(0x0898), b'\xb8\x01\x00')
chk("msgbox_pkey_13", flat(0x0891), b'\x83\x3e\xda\x29\x0d')
chk("msgbox_epilogue", flat(0x089F), b'\x5f\x5e\x5d\xcb')
# msg (0x08A3)
chk("msg_prologue", flat(0x08A3), b'\x55\x8b\xec\x56\x57')
chk("msg_cmp_onoff", flat(0x08AE), b'\x83\x7e\x0a\x00')
chk_lcall("msg_getimage", 0x08C3, 0x2066, 0x13F1)
chk_lcall("msg_bar1", 0x08E8, 0x1C32, 0x13F1)
chk_lcall("msg_bar2", 0x0907, 0x1C32, 0x13F1)
chk_lcall("msg_outtextxy", 0x0925, 0x1F2A, 0x13F1)
chk("msg_ret1", flat(0x092D), b'\xb8\x01\x00')
chk_lcall("msg_putimage", 0x093A, 0x1526, 0x13F1)
chk("msg_epilogue", flat(0x0944), b'\x5f\x5e\x5d\xcb')
# WndBkgr (0x0948)
chk("WndBkgr_enter", flat(0x0948), b'\xc8\x04\x00\x00\x56\x57')
chk_lcall("WndBkgr_bar1", 0x0976, 0x1C32, 0x13F1)
chk_lcall("WndBkgr_bar2", 0x0993, 0x1C32, 0x13F1)
chk_lcall("WndBkgr_setcolor", 0x099D, 0x1D5C, 0x13F1)
chk_lcall("WndBkgr_rectangle", 0x09AB, 0x119E, 0x13F1)
chk_lcall("WndBkgr_outtextxy", 0x09C1, 0x1F2A, 0x13F1)
chk_lcall("WndBkgr_line1", 0x09DE, 0x1BCF, 0x13F1)
chk_lcall("WndBkgr_line2", 0x09FE, 0x1BCF, 0x13F1)
chk("WndBkgr_epilogue", flat(0x0A06), b'\x5f\x5e\xc9\xcb')
# InrDcr (0x18C5)
chk("InrDcr_prologue", flat(0x18C5), b'\x55\x8b\xec\x56\x57')
chk("InrDcr_updn_cmp", flat(0x18D6), b'\x83\x7e\x0e\x00')
chk("InrDcr_epilogue", flat(0x1902), b'\x5f\x5e\x5d\xcb')
# sw_ctl (0x1906)
chk("swctl_enter", flat(0x1906), b'\xc8\x02\x00\x00\x56\x57')
chk("swctl_COL_ON", flat(0x191A), b'\xb8\x3c\x00')
chk_lcall("swctl_setfillstyle", 0x192A, 0x1211, 0x13F1)
chk_lcall("swctl_bar", 0x1942, 0x1C32, 0x13F1)
chk("swctl_epilogue", flat(0x194A), b'\x5f\x5e\xc9\xcb')
# chdiska (0x38CF)
chk("chdiska_prologue", flat(0x38CF), b'\x55\x8b\xec')
chk("chdiska_cmp_2", flat(0x38D9), b'\x3d\x02\x00')
chk_lcall("chdiska_setdisk", 0x38E6, 0x1D42, 0x0000)
chk_lcall("chdiska_chdir", 0x38F0, 0x1F49, 0x0000)
# ClearRpt (0x4395)
chk("ClearRpt_prologue", flat(0x4395), b'\x55\x8b\xec')
chk("ClearRpt_xor", flat(0x4398), b'\x33\xc0')
chk("ClearRpt_store_0", flat(0x439E), b'\xc7\x87\xba\x29\x00\x00')
chk("ClearRpt_cmp_10", flat(0x43A5), b'\x3d\x0a\x00')
chk("ClearRpt_epilogue", flat(0x43AA), b'\x5d\xcb')
# draw_bt (0x4FC9)
chk("drawbt_enter", flat(0x4FC9), b'\xc8\x02\x00\x00\x56')
chk("drawbt_imul_12", flat(0x4FD4), b'\x6b\xc0\x0c')
chk("drawbt_cmp_1", flat(0x4FDC), b'\x26\x83\x3f\x01')
chk("drawbt_cmp_3", flat(0x500A), b'\x26\x83\x3f\x03')
chk("drawbt_push_0", flat(0x5021), b'\x6a\x00')
chk("drawbt_ret_1", flat(0x5057), b'\xb8\x01\x00')
chk("drawbt_epilogue", flat(0x505A), b'\x5e\xc9\xcb')
# glaspos (0x4979)
chk("glaspos_enter", flat(0x4979), b'\xc8\x04\x00\x00\x56\x57')
chk_lcall("glaspos_rectangle", 0x49B2, 0x119E, 0x13F1)
chk_lcall("glaspos_bar", 0x49EE, 0x1C32, 0x13F1)
chk_lcall("glaspos_itoa", 0x4A09, 0x4055, 0x0000)
chk_lcall("glaspos_outtextxy", 0x4A2E, 0x1F2A, 0x13F1)
# drawfl (0x4A4A)
chk("drawfl_enter", flat(0x4A4A), b'\xc8\x0a\x00\x00\x56\x57')
chk_lcall("drawfl_putpixel", 0x4AA0, 0x2046, 0x13F1)
# draw (0x4ACF)
chk("draw_enter", flat(0x4ACF), b'\xc8\x1c\x00\x00\x56\x57')
chk_p8("draw_setcolor_COLBKL", 0x4AD5, 0x3B)
chk_lcall("draw_setcolor", 0x4AD7, 0x1D5C, 0x13F1)
chk_p16("draw_str0", 0x4ADE, 0x133B)
chk_p16("draw_y453", 0x4AE1, 0x01C5)
chk_p16("draw_x150", 0x4AE4, 0x0096)
chk_lcall("draw_outtextxy_zero", 0x4AE7, 0x1F2A, 0x13F1)
chk_str("draw_str_zero", 0x133B, b"0")
chk_p16("draw_rect_X0_160", 0x4C07, 0x00A0)
# dlgsort (0x505D)
chk("dlgsort_enter", flat(0x505D), b'\xc8\x14\x00\x00')
chk_p8("dlgsort_WB_x1", 0x5070, 0x6E)
chk_str("dlgsort_Sorting", 0x134B, b"Sorting")
chk_p16("dlgsort_rect1_yb", 0x508A, 0x0118)
chk_p16("dlgsort_rect1_xr", 0x508D, 0x015E)
chk_p16("dlgsort_rect1_y1", 0x5090, 0x0106)
chk_p16("dlgsort_rect1_x1", 0x5093, 0x0122)
chk_lcall("dlgsort_rectangle1", 0x5096, 0x119E, 0x13F1)
chk_str("dlgsort_K1", 0x1353, b"K1:+dz")
chk_str("dlgsort_K2", 0x135A, b"K2:-dz")
chk_str("dlgsort_Pixels", 0x1361, b"Pixels:")
chk("dlgsort_fsort", flat(0x511A), b'\xff\x36\xd2\x29')
chk_p8("dlgsort_itoa_10", 0x5177, 0x0A)
# minmax (0x5A33)
chk("minmax_enter", flat(0x5A33), b'\xc8\x06\x00\x00')
chk("minmax_les_itabl", flat(0x5A37), b'\xc4\x1e\x40\x2a')
chk("minmax_init_i", flat(0x5A8D), b'\x66\xc7\x46\xfa\x01\x00\x00\x00')
chk("minmax_mul6", flat(0x5AA0), b'\xb8\x06\x00')
chk("minmax_z_12000", flat(0x5D74), b'\x3d\xe0\x2e')
chk("minmax_xy_23500", flat(0x5D44), b'\x3d\xcc\x5b')
chk("minmax_lo_10", flat(0x5D38), b'\x3d\x0a\x00')
chk("minmax_ret0", flat(0x5D79), b'\x33\xc0\xc9\xcb')
chk("minmax_ret_neg1", flat(0x5DB6), b'\xb8\xff\xff\xc9\xcb')
chk("minmax_ret1", flat(0x5DBB), b'\xb8\x01\x00\xc9\xcb')
chk("minmax_fmul_nglas", flat(0x5D0D), b'\x9b\xdc\x0e\xa2\x29')
# htime (0x60AE)
chk("htime_enter", flat(0x60AE), b'\xc8\x1c\x00\x00')
chk("htime_nmax_check", flat(0x60BA), b'\x66\x83\x3e\x84\x29\x00')
chk_p16("htime_gi_x1", 0x60D1, 0x00A0)
chk_p16("htime_gi_y1", 0x60CE, 0x01D0)
chk_p16("htime_gi_x2", 0x60CB, 0x01CC)
chk_p16("htime_gi_y2", 0x60C8, 0x01DA)
chk_lcall("htime_getimage", 0x60D4, 0x2066, 0x13F1)
chk("htime_step_freq", flat(0x6217), b'\x66\x0f\xbf\x06\x88\x29')
chk("htime_imul_t", flat(0x621D), b'\x66\x0f\xaf\x46\xf8')
chk("htime_div_1000", flat(0x6268), b'\x66\xbb\xe8\x03\x00\x00')
chk_lcall("htime_putimage", 0x6260, 0x1526, 0x13F1)
chk_str("htime_Time", 0x136B, b"Time: ")
chk_str("htime_colon", 0x1372, b":")
chk("htime_div_3600", flat(0x6297), b'\xbb\x10\x0e')
chk("htime_div_60", flat(0x62DE), b'\xbb\x3c\x00')
# progbar (0x5F6B)
chk("progbar_enter", flat(0x5F6B), b'\xc8\x0a\x00\x00\x56\x57')
chk_p8("progbar_fill_7", 0x5FA4, 0x07)
chk_p8("progbar_fill_1a", 0x5FA6, 0x01)
chk_lcall("progbar_setfillstyle1", 0x5FA8, 0x1211, 0x13F1)
chk_p8("progbar_color_12", 0x5FE1, 0x0C)
chk_lcall("progbar_setcolor1", 0x5FE3, 0x1D5C, 0x13F1)
chk_str("progbar_pct", 0x1369, b"%")
chk_p8("progbar_fill_blue", 0x6013, 0x01)
chk_p8("progbar_fill_1b", 0x6015, 0x01)
chk_lcall("progbar_setfillstyle2", 0x6017, 0x1211, 0x13F1)
# dlgdim (0x634C)
chk("dlgdim_enter", flat(0x634C), b'\xc8\x1a\x00\x00\x56\x57')
chk_str("dlgdim_title", 0x1376, b"Dimensions Modification")
chk_p16("dlgdim_rect1_yb", 0x637B, 0x00F0)
chk_p16("dlgdim_rect1_xr", 0x637E, 0x00FA)
chk_p16("dlgdim_rect1_y1", 0x6381, 0x00DE)
chk_p16("dlgdim_rect1_x1", 0x6384, 0x00BE)
chk_lcall("dlgdim_rectangle1", 0x6387, 0x119E, 0x13F1)
chk_p16("dlgdim_line1_y2", 0x6425, 0x00E6)
chk_p16("dlgdim_line1_x2", 0x6428, 0x00B9)
chk_p16("dlgdim_line1_y1", 0x642B, 0x00E6)
chk_p16("dlgdim_line1_x1", 0x642E, 0x0091)
chk_lcall("dlgdim_line1", 0x6431, 0x1BCF, 0x13F1)
chk_str("dlgdim_K", 0x138E, b"K(%):")
chk_str("dlgdim_Kx", 0x1394, b"Kx(%):")
chk_str("dlgdim_Ky", 0x139B, b"Ky(%):")
chk_str("dlgdim_Kz", 0x13A2, b"Kz(%):")
# dlgload (0x3AAF)
chk("dlgload_enter", flat(0x3AAF), b'\xc8\x04\x00\x00')
chk_str("dlgload_title", 0x1221, b"Glass Load")
chk_str("dlgload_123", 0x122C, b"1   2   3")
chk_str("dlgload_456", 0x1239, b"4   5   6")
chk_str("dlgload_789", 0x1243, b"7   8   9")
chk_str("dlgload_10", 0x1236, b"10")
# gselect (0x3BC7)
chk("gselect_enter", flat(0x3BC7), b'\xc8\x38\x00\x00\x56\x57')
chk_str("gselect_title", 0x1250, b"Glass select")
chk_str("gselect_gn", 0x125D, b"Glass:  n:")
# scan_ms (0x5DC0)
chk("scanms_enter", flat(0x5DC0), b'\xc8\x02\x00\x00\x56\x57')
chk("scanms_pkey_0", flat(0x5DC6), b'\xc7\x06\xda\x29\x00\x00')

# ═════════════════════════════════════════════════════════════════════
#  PROJ5.CPP — dlgcfg() switch table & safety checks
# ═════════════════════════════════════════════════════════════════════
section("dlgcfg() + safety")
# Switch table: 38 entries at seg+0x182D (case values) and seg+0x1879 (jump targets)
_B = SEG  # segment offset base for code array
for i in range(37):
    val = struct.unpack_from('<H', exe, HDR + _B + 0x182D + i*2)[0]
    chk_val(f"dlgcfg_case_{i}", val == i, f"got {val}")
chk_val("dlgcfg_case_255", struct.unpack_from('<H', exe, HDR + _B + 0x182D + 37*2)[0] == 255)

# PT2 safety: PT2 port writes (0x314, 0x315, 0x317) only in PIC segment
code_area = exe[HDR:HDR + len(exe) - HDR]
pic_start = PIC_SEG
pic_end = PIC_SEG + 0x2000
for port in [0x314, 0x315, 0x317]:
    pat = struct.pack("<BH", 0xBA, port)  # mov dx, port
    pos = 0
    outside = []
    while True:
        pos = code_area.find(pat, pos)
        if pos < 0: break
        # Check for OUT (0xEE) within 8 bytes
        has_out = any(code_area[pos+3+j:pos+4+j] == b'\xee' for j in range(8) if pos+4+j < len(code_area))
        if has_out and not (pic_start <= pos < pic_end):
            outside.append(pos)
        pos += 1
    chk_val(f"PT2_0x{port:03X}_only_in_PIC", len(outside) == 0,
            f"{len(outside)} writes outside PIC: {[hex(x) for x in outside[:3]]}")

# LRG port (0x31C) — limited to pi_ini, pump toggle, main exit
lrg_pat = struct.pack("<BH", 0xBA, 0x31C)
pos = 0
lrg_locs = []
while True:
    pos = code_area.find(lrg_pat, pos)
    if pos < 0: break
    for j in range(1, 10):
        if pos+3+j < len(code_area) and code_area[pos+3+j] == 0xEE:
            lrg_locs.append(pos)
            break
    pos += 1
chk_val("LRG_writes_limited", 3 <= len(lrg_locs) <= 6,
        f"found {len(lrg_locs)} LRG write locations")

# Exit path: sh_close far call at code offset 0xA55A (proj5 seg offset 0x12DA)
chk("exit_sh_close_lcall", flat(0x12DA), b'\x9a\x8f\x02\x5c\x11')
# Exit path: program_pt2 far call
chk("exit_program_pt2_lcall", flat(0x12F1), b'\x9a\xeb\x01\x5c\x11')
# f_gate=0 in exit
chk("exit_f_gate_0", flat(0x12E5), b'\xc7\x06\x92\x29\x00\x00')
# Display loop: f_pt2 flag check
chk("display_f_pt2_check", flat(0x1153), b'\x83\x7e\xf4\x00')

# ═════════════════════════════════════════════════════════════════════
#  PIC.CPP — laser hardware functions
# ═════════════════════════════════════════════════════════════════════
section("PIC.CPP")
# pi_ini at PIC segment offset 0x0002
chk("pi_ini_prologue", pic(0x0002), b'\x55\x8b\xec')
# program_pt2 at offset 0x01EB
chk("program_pt2_prologue", pic(0x01EB), b'\x55\x8b\xec')
# sh_close at offset 0x028F
chk("sh_close_prologue", pic(0x028F), b'\x55\x8b\xec')
# pi_ini and process far calls already verified by full lcall checks in main()/dlgstart()
# Key port values in pi_ini region: RG(0x30C), LRG(0x31C), PPI.ctrl(0x30B)
_pi = exe[pic(0x0002):pic(0x0110)]
chk_val("pi_ini_has_RG_30C", b'\xba\x0c\x03' in _pi)
chk_val("pi_ini_has_LRG_31C", b'\xba\x1c\x03' in _pi)
chk_val("pi_ini_has_PPI_ctrl_30B", b'\xba\x0b\x03' in _pi)
chk_val("pi_ini_has_PT2_ctrl_317", b'\xba\x17\x03' in _pi)
chk_val("pi_ini_has_PPI_mode_82", b'\xb0\x82' in _pi)
chk_val("pi_ini_has_K1_96", b'\xb0\x96' in _pi)
# program_pt2: writes to PT2 ch0/ch1 (0x314/0x315)
_pt2 = exe[pic(0x01EB):pic(0x028F)]
chk_val("program_pt2_has_0x314", b'\xba\x14\x03' in _pt2)
chk_val("program_pt2_has_0x315", b'\xba\x15\x03' in _pt2)
# process: calls lpuls (contains PPI.PC=0x30A writes)
_proc = exe[pic(0x02AC):pic(0x0600)]
chk_val("process_has_PPI_PC_30A", b'\xba\x0a\x03' in _proc)
chk_val("process_has_CMOS_319", b'\xba\x19\x03' in _proc)

# ═════════════════════════════════════════════════════════════════════
#  RDWRF.CPP — file I/O functions
# ═════════════════════════════════════════════════════════════════════
section("RDWRF.CPP")
# RdCfg at RDWRF seg offset 0x00DA (far call target 1229:00DA)
chk("RdCfg_enter", rdw(0x00DA), b'\xc8')  # enter instruction
# rdcft_t at 0x077D
chk("rdcft_t_entry", rdw(0x077D), b'\xc8')  # enter instruction
# rdbft_t at 0x15F8
chk("rdbft_t_entry", rdw(0x15F8), b'\xc8')  # enter instruction
# rdbmp at 0x1702
chk("rdbmp_entry", rdw(0x1702), b'\xc8')  # enter instruction
# BFT/BMP magic strings present in RDWRF segment
_rdwrf_all = exe[rdw(0x0000):rdw(0x2000)]
chk_val("rdwrf_has_bf_magic", b'bf' in _rdwrf_all)
chk_val("rdwrf_has_BM_magic", b'BM' in _rdwrf_all)
# wrt_bft at 0x1502
chk("wrt_bft_entry", rdw(0x1502), b'\xc8')
# FlashRd call from main
chk("main_lcall_FlashRd", flat(0x0203), b'\x9a\x26\x03\x29\x12')
# FlashWr call from dlgstart
chk("dlgstart_lcall_FlashWr", flat(0x416A), b'\x9a\x04\x04\x29\x12')
# Key string "flash.dat"
chk_val("str_flash_dat", b'flash.dat' in exe)
# cfgmas buffer size 50 (push 50=0x32 ... fgets or similar)
chk_val("str_flint1_cfg", b'flint1.cfg' in exe)
chk_val("str_flint9_cfg", b'flint9.cfg' in exe)

# ═════════════════════════════════════════════════════════════════════
#  MSKEYC.CPP — mouse/keyboard functions
# ═════════════════════════════════════════════════════════════════════
section("MSKEYC.CPP")
# out_time at MSKEYC segment offset 0x0000 — single retf (empty stub in v2.76+)
chk("out_time_retf", msk(0x0000), b'\xcb')
# ms_init far call from main
chk("main_lcall_ms_init", flat(0x01A3), b'\x9a\x3a\x00\xc2\x13')
# set_gr_cursor far call
chk("main_lcall_set_gr_cursor", flat(0x01B0), b'\x9a\x01\x00\xc2\x13')
# INT 33h present in MSKEYC segment (mouse driver calls)
_msk_data = exe[msk(0x0000):msk(0x0400)]
int33_count = sum(1 for i in range(len(_msk_data)-1) if _msk_data[i]==0xCD and _msk_data[i+1]==0x33)
chk_val("MSKEYC_has_INT33h", int33_count >= 3, f"found {int33_count}")
# Key constants: beep frequencies (2100, 3000) and arrow scancodes (0x48,0x4B,0x4D,0x50)
chk_val("MSKEYC_has_beep_2100", struct.pack('<H', 2100) in _msk_data)
chk_val("MSKEYC_has_beep_3000", struct.pack('<H', 3000) in _msk_data)
# Arrow key scancodes present
chk_val("MSKEYC_has_scancode_48", bytes([0x48]) in _msk_data)  # Up arrow
chk_val("MSKEYC_has_scancode_50", bytes([0x50]) in _msk_data)  # Down arrow

# ═════════════════════════════════════════════════════════════════════
#  Data Segment — strings & version markers
# ═════════════════════════════════════════════════════════════════════
section("Strings & data")
# Version
chk_str("version_277", 0x0090, b"2.77")
# UI strings
chk_str("str_Configuration", 0x0F5D, b"Configuration")
chk_str("str_DataConvert", 0x10BE, b"Data Convert")
chk_str("str_GlassLoad", 0x1221, b"Glass Load")
chk_str("str_GlassSelect", 0x1250, b"Glass select")
chk_str("str_AfterNoise", 0x126E, b"After noise:")
# Must-have strings (search in whole EXE)
for s in [b"Start", b"Cancel", b"Save .cfg", b"Load .cfg", b"Exit?",
          b"Please wait", b"Buffer overflow", b"KPU error",
          b"File not found", b"Enter name", b"Data load",
          b"Drawing check", b"End sensors", b"Continuation",
          b"Beginning", b"Point number", b"Saved in CMOS",
          b"Are you sure?", b"Check laser"]:
    chk_val(f"str_{s.decode()}", s in exe)
# Removed strings should NOT be present
chk_val("no_F6_Statist", b'F6 Statist' not in exe)
chk_val("no_F7_Info", b'F7 Info' not in exe)
# Button names for main screen
for s in [b"F9 XYZ", b"F1 Config", b"F2 Convert", b"F3 DatLoad",
          b"F4 GlsLoad", b"F5 Start", b"F10 Exit"]:
    chk_val(f"btn_{s.decode()}", s in exe)

# ═════════════════════════════════════════════════════════════════════
#  Source files crosscheck
# ═════════════════════════════════════════════════════════════════════
section("Source crosscheck")
src_files = ["PROJ5.H", "PROJ5.CPP", "PIC.CPP", "RDWRF.CPP", "MSKEYC.CPP"]
for fname in src_files:
    chk_val(f"src_{fname}_exists", os.path.exists(os.path.join(SRC_DIR, fname)))

def read_src(name):
    p = os.path.join(SRC_DIR, name)
    if os.path.exists(p):
        with open(p, 'r', encoding='utf-8', errors='replace') as f:
            return f.read()
    return ""

src_h = read_src("PROJ5.H")
src_proj5 = read_src("PROJ5.CPP")
src_pic = read_src("PIC.CPP")
src_rdw = read_src("RDWRF.CPP")
src_msk = read_src("MSKEYC.CPP")

if src_h:
    defines = {}
    for m in re.finditer(r'#define\s+(\w+)\s+(0x[0-9a-fA-F]+|\d+)', src_h):
        defines[m.group(1)] = int(m.group(2), 0)
    chk_val("def_ADRPT0_0x300", defines.get("ADRPT0") == 0x300)
    chk_val("def_ESC_27", defines.get("ESC") == 27)
    chk_val("def_PULS_ON_0xBF", defines.get("PULS_ON") == 0xBF)
    chk_val("def_PR_OPEN_0x7F", defines.get("PR_OPEN") == 0x7F)
    chk_val("def_PUMP_ON_0x01", defines.get("PUMP_ON") == 0x01)
    chk_val("def_SHUT_ON_0x02", defines.get("SHUT_ON") == 0x02)
    chk_val("def_BNM_SCR_7", defines.get("BNM_SCR") == 7)
    chk_val("def_BNM_CFG_29", defines.get("BNM_CFG") == 29)
    chk_val("def_BNM_STRT_14", defines.get("BNM_STRT") == 14)
    chk_val("no_BNM_STAT", "BNM_STAT" not in defines)
    chk_val("no_BNM_INFO", "BNM_INFO" not in defines)
    chk_val("no_f_pump", "f_pump" not in src_h)

if src_pic:
    chk_val("pic_has_ADRPT2", "ADRPT2" in src_pic)
    chk_val("pic_has_LRG", "LRG" in src_pic)
    chk_val("pic_has_PUMP_ON", "PUMP_ON" in src_pic)
    chk_val("pic_has_gate_delay", "gate_delay" in src_pic)
    chk_val("pic_has_sh_delay", "sh_delay" in src_pic)
    chk_val("pic_has_dT", "dT" in src_pic)
    # No real out_time calls (removed in v2.76)
    pic_clean = re.sub(r'/\*.*?\*/', '', src_pic, flags=re.DOTALL)
    pic_clean = re.sub(r'//.*$', '', pic_clean, flags=re.MULTILINE)
    chk_val("pic_no_out_time_calls", len(re.findall(r'\bout_time\s*\(', pic_clean)) <= 1)

if src_msk:
    chk_val("msk_has_out_time", "out_time" in src_msk)
    chk_val("msk_has_f_beep", "f_beep" in src_msk)

if src_rdw:
    chk_val("rdw_has_gate_delay", "gate_delay" in src_rdw)
    chk_val("rdw_has_dT", "dT" in src_rdw)
    chk_val("rdw_has_sh_delay", "sh_delay" in src_rdw)
    chk_val("rdw_has_cfgmas50", "cfgmas[50]" in src_rdw)

if src_proj5:
    chk_val("proj5_version_277", '"2.77"' in src_proj5)
    chk_val("proj5_extern_LCtl", "extern unsigned char LCtl" in src_proj5)
    chk_val("proj5_has_gate_delay", "gate_delay" in src_proj5)
    chk_val("proj5_no_dlgstat", src_proj5.count("int dlgstat") == 0)
    chk_val("proj5_no_infobox", src_proj5.count("int infobox") == 0)
    chk_val("proj5_has_PgUp", "PgUp" in src_proj5)
    chk_val("proj5_has_program_pt2", "program_pt2" in src_proj5)
    chk_val("proj5_safe_exit_LRG", "LRG" in src_proj5)

# ═════════════════════════════════════════════════════════════════════
#  SUMMARY
# ═════════════════════════════════════════════════════════════════════
print("\n" + "=" * 70)
print("  RESULTS BY SECTION:")
print("=" * 70)
for name, (p, f) in sec_stats.items():
    total = p + f
    status = "OK" if f == 0 else "FAIL"
    print(f"  [{status:4s}] {name}: {p}/{total} pass" + (f", {f} FAIL" if f else ""))

print("\n" + "=" * 70)
total = passed + failed
print(f"  TOTAL: {passed}/{total} PASS, {failed} FAIL")
if failed:
    print(f"\n  FAILED CHECKS ({failed}):")
    for d in fail_details:
        print(f"    {d}")
    print("\n  *** VERIFICATION FAILED ***")
else:
    print("\n  ALL CHECKS PASSED!")
print("=" * 70)

sys.exit(0 if failed == 0 else 1)
