# FLINT+ — Программа управления лазерной гравировальной установкой

## Что это за программа?

**FLINT+** — это программа для управления **лазерной установкой**, которая создаёт **объёмные изображения внутри стекла**. Вы наверняка видели такие сувениры: стеклянный кубик, а внутри — 3D-модель здания, логотип, фигурка или надпись. Именно для производства таких изделий и предназначена эта программа.

### Как работает технология?

Представьте себе стеклянный кубик, закреплённый на подвижном столике. Над ним — мощный лазер. Лазерный луч фокусируется **внутри** стекла (а не на поверхности) и создаёт крошечную микротрещину — **одну точку** размером с песчинку. Затем столик чуть-чуть сдвигается, и лазер делает следующую точку. Из тысяч таких точек складывается трёхмерное изображение.

Программа FLINT+ делает всю работу:
- Загружает 3D-модель (набор координат точек)
- Двигает столик с точностью до сотых долей миллиметра
- Следит за безопасностью (лазерные затворы, концевые датчики)
- Стреляет лазером в нужный момент
- Управляет лампой накачки и электро-оптическим затвором лазера
- Воспроизводит звуковые сигналы при критических событиях

### Кто и когда это сделал?

- **Разработчик**: автор под псевдонимом «iB»
- **Организация**: ИЛТиП (ILTiP Ltd) — Институт лазерных технологий и инжиниринга, г. Сосновый Бор, Ленинградская область, Россия
- **Телефон**: +7(81269)22622
- **Годы разработки**: с 1996 по 2004 год
- **Текущая версия**: 2.77 (сентябрь 2004)

---

## На чём написана программа?

| Что | Чем сделано |
|-----|-------------|
| **Язык программирования** | C/C++ |
| **Среда разработки** | Borland C++ (IDE 90-х годов) |
| **Операционная система** | MS-DOS — старая текстовая операционка, которая была до Windows |
| **Графика** | Собственная графическая библиотека Borland (BGI) — рисует окна, кнопки, картинки прямо на экране в режиме 640×480 пикселей |
| **Управление оборудованием** | Прямые команды в электронные платы через порты ввода-вывода — программа напрямую «разговаривает» с железом |

> **Почему DOS, а не Windows?** В 1996 году для управления оборудованием в реальном времени DOS подходил лучше — он не отвлекался на другие задачи и давал программе полный контроль над компьютером и подключёнными устройствами.

---

## Какое оборудование подключено?

Программа управляет целым набором устройств, подключённых к компьютеру через специальные платы расширения:

### Координатный столик (3 оси)
Стеклянный образец закрепляется на столике, который может двигаться по трём направлениям:
- **Ось X** — влево/вправо (до 235 мм)
- **Ось Y** — вперёд/назад (до 235 мм)
- **Ось Z** — вверх/вниз (до 110 мм)

Столик приводят в движение **шаговые двигатели** — моторчики, которые поворачиваются ровно на один «шажок» по команде компьютера. Один шаг — примерно 0.01 мм. Это позволяет позиционировать образец с очень высокой точностью.

### Лазер
Мощный импульсный лазер (предположительно Nd:YAG). Каждый «выстрел» создаёт одну точку внутри стекла. Программа управляет:
- **Включением/выключением** лазера
- **Частота импульсов** (period от 20 до 655 мс)
- **Защитным затвором** — механическая шторка, которая блокирует луч, когда лазер не нужен

### Датчики безопасности
- **6 концевых датчиков** (по 2 на каждую ось) — не дают столику «уехать» за пределы и сломать механику
- **10 датчиков контроля затворов** — проверяют, что при каждом импульсе нужные затворы действительно открылись

### Электромагнитные затворы (10 штук)
Установка может обрабатывать **до 9 образцов одновременно**. Каждому образцу соответствует свой затвор (EM1–EM9), плюс один общий (EM10). Перед каждым импульсом затворы переключаются так, чтобы луч попал именно в нужный образец.

### CMOS-счётчик (с батарейкой)
Специальная микросхема со своей батарейкой, которая запоминает, сколько точек уже обработано. Если вдруг отключится электричество — после включения можно продолжить с того места, где остановились, а не начинать заново.

---

## Что умеет программа? (Все возможности)

### Главный экран

При запуске программа показывает **главный экран** со следующей информацией:

- **Имя текущего файла** с данными
- **Nmax** — сколько всего точек в загруженном объекте
- **Nlast** — на какой точке остановились при последней обработке
- **Параметры стекла** — тип стекла, показатель преломления, размеры (X × Y × Z)
- **Контрольная картинка** — схематичное изображение объекта, можно переключать проекцию кнопкой F9 (вид сверху XY → вид сбоку YX → вид сбоку XZ → вид сбоку YZ)
- **Матрица затворов** (при работе с 9 образцами) — какие из 9 позиций активны
- **Расчётное время обработки** — сколько примерно займёт изготовление изделия (часы:минуты:секунды)
- **Логотип «FLINT»** — красивая надпись в правом верхнем углу
- **Индикатор «Demo»** — показывает, что оборудование не подключено (программа работает в режиме демонстрации)
- **Номер версии** — отображается на экране (например, «2.77»)
- **Индикатор Dr.check** — показывает состояние проверки датчиков затворов
- **Сетка повторов (Reiteration grid)** — матрица 3×3 (+ десятый затвор) с визуальным отображением количества повторных попыток для каждого затвора

В нижней и правой части экрана — **кнопки** для доступа ко всем функциям:

---

### F1 — Настройки (Configuration)

Центральное место для настройки всех параметров установки:

**Параметры лазера:**
- **Период лазера** (Las.puls period) — интервал между импульсами (от 20 до 655 мс). Чем меньше — тем быстрее работа, но хуже качество
- **Частота шагов** (Step freq) — скорость перемещения столика (от 100 до 2000 Гц)
- **Режим скорости**: «постоянная» (constant) — столик всегда двигается с одной скоростью; «переменная» (variable) — скорость подстраивается так, чтобы перемещение успевало завершиться за время между импульсами

**Координаты указателя (X, Y, Z):**
- Задают, куда именно в стекле будет направлен лазерный фокус
- Можно менять кнопками +/– или вводить числа вручную
- При включённом режиме «Work ptr» столик **реально перемещается** при каждом изменении координат — удобно для юстировки (настройки точного положения)

**Режим работы:**
- **«1»** — один образец (один большой затвор)
- **«9»** — до 9 образцов одновременно (матрица 3×3 затворов). Можно мышкой включить/выключить любой затвор в матрице

**Безопасность:**
- **Protect open/close** — ручное открытие/закрытие защитного затвора лазера


**Управление лазером (Pump/Gate):**
- **Gate delay** — задержка срабатывания электро-оптического затвора лазера (×10 мкс, диапазон 10–500 мкс)
- **Pump/Gate** — переключатели включения/выключения лампы накачки и электро-оптического затвора лазера
- **Кнопка «X»** — сброс всех позиций затворов в режиме «9» (обнуление битовой маски)
- **dT** — поправочный коэффициент для компенсации времени вычислений конкретного ПК при расчёте переменной скорости перемещения (мс)
- **sh_delay** — задержка срабатывания электромагнитных затворов (EM1–EM9) в мс — время, необходимое физическому затвору для полного открытия после подачи команды

**Сохранение/загрузка:**
- **Load .cfg** — загрузить настройки из файла
- **Save .cfg** — сохранить текущие настройки

**Статистика:**
- **Flash nmb** — общее количество лазерных вспышек за всё время работы установки
- **Service date** — дата последнего обслуживания
- **Reset** — обнуление счётчика и установка новой даты обслуживания
- **Pixels max** — максимальное число точек, которое помещается в память

---

### F2 — Конвертер данных (Data Convert)

Мощный редактор для подготовки 3D-объектов перед гравировкой. Это «мастерская», где оператор загружает модель и подгоняет её под конкретный стеклянный образец.

**Загрузка данных:**
- Можно загрузить объект из **5 форматов**: BFT, CFT, ASC (3D Studio), BMP (чёрно-белое изображение)
- При загрузке BMP: чёрные пиксели становятся точками, можно настроить шаг dx/dy (расстояние между точками 0.1–1.5 мм) и dz (глубина второго слоя)

**Просмотр модели:**
- Контрольная картинка объекта с **4 проекциями** (кнопка «View XYZ» или клавиша **F9**): XY, YX, XZ, YZ
- **Автомасштабирование** — объект всегда помещается на экран
- **Инвертирование** (Invert) — переключение между «светлые точки на тёмном фоне» и наоборот (позволяет увидеть, как будет выглядеть в стекле)

**Редактирование позиции:**
- Кнопки **up/down/←/→** — сдвиг объекта внутри образца (шаг 0.25 мм)
- **«0→Center»** — сдвиг начала координат в центр образца
- **«C→Center»** — автоматическое центрирование объекта (геометрический центр объекта совмещается с центром стекла)
- **Показатели dT, dL, dR, dB** — расстояния от объекта до краёв стекла (Top/Left/Right/Bottom) в миллиметрах. Можно ввести нужное расстояние вручную

**Редактирование параметров стекла:**
- **Тип стекла** — выбор из справочника (кнопка «Glass:» открывает окно Glass Select)
- **Показатель преломления** (n) — можно ввести вручную (от 1.000 до 2.000)
- **Размеры образца** (Xsize, Ysize, Zsize) — в миллиметрах, можно менять кнопками или вводить вручную

**Зеркальное отражение (Mirror):**
- Переворачивает объект по горизонтали — нужно для того, чтобы при взгляде на стекло с определённой стороны изображение было правильным

**Масштабирование (Dimensions Modification):**
- Отдельное окно для изменения размера объекта
- **Общий коэффициент K** — от 50% до 200% (уменьшить вдвое или увеличить вдвое)
- **Раздельные коэффициенты** Kx, Ky, Kz — можно растягивать/сжимать по отдельным осям
- **Точка отсчёта**: «from 0» — от начала координат; «from centre» — от центра стекла
- После нажатия «Ok» координаты всех точек пересчитываются

**Сортировка (Sort):**
- Отдельное окно для оптимизации порядка точек
- Зачем: если после каждого импульса столик перемещается на небольшое расстояние — работа идёт быстрее и качественнее, чем если он «прыгает» через весь образец
- **Три режима**:
  - **Off** — сортировка отключена (точки в том порядке, как были в файле)
  - **0.5mm layers** — двухэтапная сортировка: сначала точки группируются по «слоям» толщиной 0.5 мм по оси Z, затем внутри каждого слоя выстраиваются в оптимальный маршрут (минимальное перемещение между соседними точками)
  - **K*dz** — «умная» сортировка с коэффициентами. Алгоритм «ближайшего соседа» с учётом направления по Z: движение «вниз» (K1) и «вверх» (K2) имеют разный «вес» (по умолчанию K1=15, K2=10). Это учитывает, что двигаться вглубь стекла «дешевле», чем обратно
- **Sort/time** — запуск сортировки с подсчётом расчётного времени обработки
- Все три режима с прогресс-баром и возможностью прерывания по ESC

**Сохранение результата:**
- **Data Save** — сохранение подготовленного объекта в форматы BFT, CFT или ASC
- При сохранении автоматически применяются: сдвиг позиции, зеркалирование, пересчёт по преломлению стекла

---

### F3 — Загрузка данных (Data Load)

Быстрая загрузка файла с точками **для обработки** (прямо из главного экрана, без конвертера):
- Выбор файла через навигатор (каталоги, диски, имя файла)
- Поддержка форматов **BFT** и **CFT**
- После загрузки объект сразу отображается на главном экране, подсчитывается время обработки

---

### F4 — Загрузка стекла (Glass Load)

Окно для физической загрузки/выгрузки стеклянных образцов. Поддерживает навигацию клавишами PgUp/PgDn:
- **Up** — столик поднимается вверх до концевых датчиков: сначала быстрый ход, затем точная привязка. После этого координаты известны, и можно начинать работу
- **Down** — столик опускается вниз для замены образцов
- **Cancel** — отмена без перемещения

---

### F5 — Запуск обработки (Start)

Самая важная функция — **запуск процесса гравировки**. Окно с множеством настроек:

**Откуда начать:**
- **Beginning** — с самого начала (счётчик CMOS обнуляется, статистика повторов сбрасывается)
- **Point number** — с произвольной точки (можно ввести номер напрямую с клавиатуры)
- **Continuation** — продолжить с того места, где остановились в прошлый раз
- **Saved in CMOS** — восстановить позицию из аппаратного счётчика (после аварийного выключения питания)

**Безопасность:**
- **End sensors** — если включено, перед началом работы столик обязательно «привязывается» к концевым датчикам (для точного определения нулевой точки)
- **Drawing check** — если включено, после каждого импульса программа проверяет по датчикам, что все затворы действительно сработали. Если нет — до 11 повторных попыток
- **Реакция на помехи (After noise):**
  - **Stop** — полная остановка с сообщением об ошибке
  - **Coord.reboot/continuation** — автоматическая перепривязка к датчикам и продолжение работы
  - **Ignore** — игнорировать помеху и продолжить

**Предпусковые проверки:**
- Программа проверяет, что все точки объекта не выходят за **пределы хода столика** (0–235 мм по X и Y, 0–110 мм по Z)
- Проверяет, что точки не выходят за **пределы стеклянного образца**
- Если что-то не так — выдаёт предупреждение и не позволяет запустить процесс

**Сам процесс:**
- В нижней части экрана — **прогресс-бар** и текущий номер точки
- В верхней части — сообщение «For STOP: press ESC»
- Для каждой точки: вычисление координат → перемещение столика → лазерный импульс с контролем затворов → отрисовка точки на контрольной картинке → инкремент CMOS-счётчика
- При ошибке лазера: окно «Check laser. Retry: Ok» с тремя вариантами — «Ok» (повторить), «No» (остановить), «Nx» (пропустить эту точку и перейти к следующей)
- По окончании: три звуковых сигнала и сообщение «Ok. TABLE END»

---

### F9 — Переключение проекции (XYZ)

Циклически переключает **ракурс контрольной картинки** на главном экране:
- XY (вид сверху) → YX (перевёрнутый вид) → XZ (фронтальный вид сбоку) → YZ (боковой вид сбоку) → снова XY

---

### F10 — Выход (Exit)

Запрос подтверждения «Exit?» и выход из программы. Освобождает память и закрывает графический режим.

---

### Демо-режим

Если при запуске программа **не обнаруживает подключённых плат**, она автоматически включает **демонстрационный режим**. В этом режиме:
- Все перемещения столика **эмулируются** (с задержками, имитирующими реальное время)
- Лазерные импульсы лишь увеличивают счётчик
- Все меню и функции работают полностью
- На экране отображается надпись «Demo»

Это позволяет изучать программу, готовить файлы и тестировать настройки без подключения к реальной установке.

---

### Навигатор файлов

Во всех окнах открытия/сохранения файлов работает **встроенный файловый менеджер**:
- Список подкаталогов с прокруткой (переход по клику или кнопками up/down)
- Список файлов (отфильтрованных по типу) с прокруткой
- **Переключение типа файлов** (bft/cft/asc/bmp) чекбоксами
- **Смена диска** (A:–J:) через выпадающее меню
- **Ручной ввод имени файла** с клавиатуры
- Текущий путь отображается вверху окна
- Файлы и каталоги отсортированы по алфавиту

---

### Управление по справочнику стёкол

В файле FLINT.GLS хранится каталог марок стекла с их характеристиками. Окно «Glass Select» (вызывается из конвертера) позволяет:
- Выбрать марку стекла из списка (K8, TF10, LK3, STK и др.)
- Автоматически установить показатель преломления для выбранной марки
- Список с прокруткой, отображение марки и числового значения n
- Навигация клавишами **PgUp/PgDn** для быстрой прокрутки

---

## Понятие «показатель преломления» и зачем он нужен

Когда лазерный луч входит в стекло, он **отклоняется** (преломляется). Из-за этого точка фокусировки оказывается не там, где ожидалось. Чем «плотнее» стекло — тем сильнее отклонение. Показатель преломления (n) — число, которое описывает это свойство (для обычного стекла ~ 1.5). Программа учитывает это число при пересчёте координат по оси Z, чтобы точки оказались **точно на своих местах** внутри стекла.

---

## Форматы файлов данных

### BFT (Binary Flint Table) — основной формат
**Двоичный** (компактный, нечитаемый глазом) файл:
- Заголовок: «bf», показатель преломления, размеры стекла, количество точек
- Далее — координаты X, Y, Z для каждой точки
- Быстро загружается, занимает мало места

### CFT (Character Flint Table) — текстовый формат
**Текстовый** (можно открыть в блокноте) файл:
```
flinttab
nglass=	1.506
xsize=	50
ysize=	50
zsize=	50
1:	120	340	80
2:	125	342	80
...
```
Удобен для отладки, но загружается медленнее.

### ASC — формат 3D Studio
Текстовый экспорт из программы **Autodesk 3D Studio** (популярный 3D-редактор тех лет). Можно создать модель в 3D Studio и экспортировать для гравировки.

### BMP — чёрно-белое изображение
Обычная картинка формата Windows Bitmap, но строго **двухцветная** (чёрно-белая). Чёрные пиксели превращаются в точки для гравировки. Можно задать шаг и глубину — получится плоское или двухслойное изображение внутри стекла.

---

## Файловая структура проекта

### Исходный код программы

| Файл | Зачем нужен |
|------|-------------|
| [PROJ5.CPP](PROJ5.CPP) | **Главный файл программы.** Всё, что вы видите на экране: меню, кнопки, окна настроек, конвертер данных, окно запуска — всё здесь. Также здесь логика запуска, сортировка точек и расчёт времени. Это самый большой файл — 1631 строка |
| [PROJ5.H](PROJ5.H) | **Файл настроек и данных.** Здесь хранятся: расположение всех кнопок на экране (координаты, размеры), цвета интерфейса, адреса портов оборудования, шрифтовые данные для логотипа, маска курсора мыши, все глобальные переменные программы. Без этого файла остальные не скомпилируются |
| [PIC.CPP](PIC.CPP) | **Файл управления оборудованием.** Здесь «живёт» вся работа с реальным железом: инициализация плат, перемещение столика, лазерные импульсы, контроль затворов и датчиков, основной цикл обработки (прохождение по всем точкам), программирование таймера PT2 (генератор частоты лазера и задержки электро-оптического затвора), управление лампой накачки. Функции `seg_time()`, `program_pt2()`, `read_pt2()`, `calc_k2()` добавлены в v2.71+. 501 строка |
| [MSKEYC.CPP](MSKEYC.CPP) | **Файл работы с мышью и клавиатурой.** Инициализация мыши, обработка кликов, нажатий клавиш, автоповтор при удержании кнопки, управление курсором со стрелок клавиатуры, звуковой сигнал. Функция `out_time()` (вывод часов) присутствует, но её тело пустое начиная с v2.76 — обновление экрана раз в секунду вызывало пропуск импульса лазера. Примерно 170 строк |
| [RDWRF.CPP](RDWRF.CPP) | **Файл чтения и записи данных.** Открытие/сохранение файлов всех форматов (BFT, CFT, ASC, BMP), работа с каталогами и дисками, чтение/запись конфигурации (10 полей: xptr, yptr, zptr, step, l_period, gate_delay, step_freq, f_const, dT, sh_delay + glpos9 для режима «9»), загрузка каталога стёкол, работа со счётчиком вспышек. Примерно 420 строк |
| [COMPILE.bat](COMPILE.bat) | **Скрипт сборки.** Автоопределение среды (DOS/Win9x или Windows NT + DOSBox-X), настройка путей к компилятору Borland C++ 4.5, компиляция и линковка. 244 строки |

### Файлы конфигурации и справочники

| Файл | Зачем нужен |
|------|-------------|
| [FLINT1.CFG](FLINT1.CFG) | **Настройки для режима «1 образец».** Хранит координаты указателя (X,Y,Z), размер шага, период лазера, частоту шагов, режим скорости, а также gate_delay, dT и sh_delay. Загружается при старте программы. Двоичный файл, 50 байт |
| [FLINT9.CFG](FLINT9.CFG) | **Настройки для режима «9 образцов».** Те же данные, что в FLINT1.CFG, плюс информация о том, какие из 9 затворов активны |
| [FLINT.GLS](FLINT.GLS) | **Справочник марок стекла.** Текстовый список: марка стекла и её показатель преломления. Например: K8 = 1.506, TF10 = 1.557, LK3 = 1.692. Используется при выборе стекла в конвертере. |

### Примеры 3D-объектов

| Файл | Зачем нужен |
|------|-------------|
| [MEGAFON1.BFT](MEGAFON1.BFT) | Готовый объект — **логотип Мегафон (вариант 1)**. Для тестирования и демонстрации |
| [MEGAFON2.BFT](MEGAFON2.BFT) | Готовый объект — **логотип Мегафон (вариант 2)**. Для тестирования и демонстрации |


### Документация (история изменений)

| Файл | Зачем нужен |
|------|-------------|
| [FLINT_UTF8.TXT](FLINT_UTF8.TXT) | **Журнал изменений v1.0–2.60** (427 строк). Полная история с 1996 года: 44 версии, от базовой КПУ до форматов BFT/BMP, сортировки и серийной обработки |
| [FLINT_UTF8.txt](FLINT_UTF8.txt) | **Журнал изменений v2.61–2.77** (~120 строк). 9 версий (2003–2004): gate delay, таймер PT2, удаление часов, sh_delay |

---

## Типичный рабочий процесс оператора

Вот как выглядит работа с программой от начала до конца:

1. **Запуск программы** — загружается главный экран. Если оборудование подключено, программа определяет его автоматически. Если нет — включается демо-режим.

2. **Загрузка 3D-модели** (F2 → Data Load) — оператор открывает файл с объектом (например, cube.bft) через файловый навигатор.

3. **Подготовка объекта** (F2) — в окне конвертера:
   - Выбрать марку стекла и задать размеры
   - Отцентрировать объект кнопкой «C→Center»
   - При необходимости — отзеркалить, масштабировать
   - Запустить сортировку для оптимального маршрута
   - Сохранить подготовленный файл (Data Save)

4. **Загрузка для обработки** (F3) — загрузить подготовленный файл на главный экран.

5. **Настройка оборудования** (F1) — задать период лазера, частоту шагов, режим скорости, параметры gate_delay, dT и sh_delay.

6. **Установка образца** (F4 → Down) — столик опускается, оператор крепит стекло. Затем F4 → Up — столик поднимается и привязывается к датчикам.

7. **Запуск** (F5) — выбрать «Beginning», включить «End sensors» и «Drawing check», нажать «Start». Программа начинает гравировку.

8. **Наблюдение** — на экране шкала прогресса, номер текущей точки, контрольная картинка заполняется по мере обработки.

9. **Завершение** — три звуковых сигнала, надпись «TABLE END». Извлечь готовое изделие (F4 → Down).

---

## Размер рабочей области

| Ось | Рабочий ход | В миллиметрах |
|-----|-------------|---------------|
| X (влево-вправо) | 0–23500 шагов | ~235 мм |
| Y (вперёд-назад) | 0–23500 шагов | ~235 мм |
| Z (вверх-вниз) | 0–11000 шагов | ~110 мм |

Максимальный размер стеклянного образца задаётся в настройках (Zsize до 120 мм), но рабочий ход столика по оси Z — **110 мм** (11000 шагов).

---

## Происхождение файлов в папке «Flint 2.77 src/»

Файлы в папке `Flint 2.77 src/` — это **не оригинальные исходники**, а **результат обратного инжиниринга**. Заголовок файла PROJ5.CPP прямо указывает:

> `ver.2.77 (reconstructed from v2.61 + changelog v2.61-v2.77)`

### Зачем это понадобилось

Оригинальные исходные коды версии 2.77 были **утрачены** — сохранился только скомпилированный исполняемый файл (`PROJ5.EXE`). При этом была потребность **расширить память** программы: 16-битная версия ограничена ~80 000 точек, чего недостаточно для сложных 3D-моделей. Для создания 32-битного порта необходим компилируемый исходный код, а не только бинарник.

### Как они были созданы

Исходники v2.77 были **восстановлены путём обратного инжиниринга** оригинального EXE-файла версии 2.77. Опорой при восстановлении служили:

1. **Оригинальные исходники версии 2.61** из папки `!GENESIS/Flint 2.61/SRC/` — как базовый код, из которого выросла v2.77
2. **Дизассемблированный код** оригинального `PROJ5.EXE` v2.77 — для верификации логики и выявления отличий от v2.61
3. **Журнал изменений** `!GENESIS/Flint 2.77/FLINT_UTF8.txt` — описание всех доработок от v2.61 до v2.77 (9 версий, 2003–2004)

| Версия | Дата | Что изменилось |
|--------|------|----------------|
| **v2.70** | 01-2003 | Добавлен параметр `gate_delay` (задержка электро-оптического затвора). Реальное отображение повторов обработки (`show_reit()`). Удалено окно статистики `dlgstat()` — его содержимое перенесено в Configuration |
| **v2.71** | 2003 | Программирование аппаратного таймера PT2 (`program_pt2()`, `seg_time()`). Добавлены переключатели Pump/Gate в Configuration. Удалена кнопка «Las.adjust» |
| **v2.72–73** | 2003 | Переработана функция `move()` под фиксированную работу лампы накачки. Добавлен параметр `dT` — поправочный коэффициент для компенсации времени вычислений конкретного ПК. Функция `calc_k2()` для расчёта скорости перемещения |
| **v2.74–75** | 2003–2004 | Мелкие исправления и оптимизация |
| **v2.76** | 2004 | **Удалён вывод часов** (`out_time()` заглушена). Причина: обновление экрана раз в секунду регулярно вызывало пропуск одного импульса лазера во время обработки |
| **v2.77** | 12-09-2004 | Добавлен `sh_delay` (задержка электромагнитных затворов) в конфигурацию. Удалён `F7 Info`. Добавлен индикатор `Dr.check` на главный экран |

### Сравнение v2.61 и v2.77

| Параметр | v2.61 | v2.77 |
|----------|-------|-------|
| PROJ5.CPP | 1542 строки | 1631 строка (+89) |
| PIC.CPP | ~350 строк | 501 строка (+151) |
| Полей в конфигурации | 7 (xptr, yptr, zptr, step, l_period, step_freq, f_const) | 10 (+gate_delay, dT, sh_delay) |
| Окно статистики | Отдельное окно `dlgstat()` | Встроено в Configuration |
| Часы на экране | Работают (`out_time()`) | Удалены (пропуск импульсов) |
| Таймер PT2 | Инициализируется, но не используется | Полноценное управление (`program_pt2`, `seg_time`, `read_pt2`, `calc_k2`) |
| Pump/Gate | Нет в интерфейсе | Переключатели в Configuration |
| F7 Info | `infobox("2.61 iB")` | Удалён |

### Сборка 16-битной версии

Скрипт `COMPILE.bat` (244 строки) автоматически определяет среду:
- **DOS / Windows 9x** — нативная компиляция компилятором Borland C++ 4.5
- **Windows NT+** — компиляция через DOSBox-X (эмулятор DOS)

Флаги: `-ml` (Large memory model), `-O1` (оптимизация по размеру), `-3` (инструкции 386). Линковка с библиотеками GRAPHICS, EMU, MATHL, CL.

---

## 32-битный порт (Open Watcom / DOS4GW)

Папка `Flint 2.77 (32bit) src/` содержит **32-битный порт** программы, созданный для преодоления главного ограничения 16-битной версии — **нехватки памяти**.

### Зачем понадобился порт

16-битная версия (v2.77, Borland C++, Large memory model) выделяет всю доступную far-память через `farmalloc(farcoreleft() - 30000)`. В типичном DOS-окружении это даёт ~500 КБ — примерно **80 000 точек** максимум. Для многих 3D-моделей этого недостаточно.

32-битная версия (Open Watcom, DOS/4GW extender, Flat memory model) снимает это ограничение. Каскадная аллокация:

| Попытка | Точек | Память |
|---------|-------|--------|
| 1-я | **8 000 000** | 48 МБ |
| 2-я (fallback) | **2 000 000** | 12 МБ |
| 3-я (fallback) | **400 000** | 2.4 МБ |

Это **в 100 раз больше**, чем у 16-битной версии. После аллокации выполняется верификация памяти (запись/чтение тестовых значений в начало, середину и конец буфера).

### Компилятор и сборка

- **Компилятор**: Open Watcom C++ (`wpp386`) вместо Borland C++ 4.5
- **Расширитель памяти**: DOS/4GW (32-битный protected mode)
- **Флаги**: `-bt=dos -mf -ox -w3` (целевая платформа DOS, flat model, полная оптимизация)
- **Сборка**: `wmake -f MAKEFILE` или через `COMPILE.bat` (256 строк, автоопределение среды)

### Три новых файла

Для портирования было создано три новых файла, отсутствующих в 16-битной версии:

#### COMPAT.H — слой совместимости (~149 строк)

Набор `#define`, `inline`-функций и обёрток, которые транслируют API Borland C++ в эквивалентные вызовы Open Watcom:

| Borland C++ | Open Watcom | Что делает |
|-------------|-------------|------------|
| `outportb(p,v)` | `outp(p,v)` | Запись в порт ввода-вывода |
| `inportb(p)` | `inp(p)` | Чтение из порта |
| `farmalloc(s)` | `malloc(s)` | Выделение памяти (far → flat) |
| `farfree(p)` | `free(p)` | Освобождение памяти |
| `farcoreleft()` | `_memavl()` | Доступная память |
| `getdisk()` | `_getdrive()-1` | Текущий диск (коррекция нумерации) |
| `bioskey(cmd)` | `_bios_keybrd(...)` | Работа с клавиатурой через BIOS |
| `findfirst/findnext` | `_dos_findfirst/next` | Поиск файлов с обёрткой `struct ffblk` |
| `sound()/nosound()` | Прямое программирование PIT | Звук через PC speaker |
| `struct date / getdate()` | `dosdate_t / _dos_getdate()` | Получение текущей даты |
| `int86x(0x33,...)` | `int386(0x33,...)` | Управление мышью (32-битные регистры) |

#### BGI32.CPP + BGI32.H — графическая библиотека (832 + 97 строк)

Полная реализация подмножества Borland Graphics Interface (BGI), написанная с нуля для работы с VGA mode 12h (640×480, 16 цветов, 4 битовых плоскости):

- **Инициализация**: `initgraph()` / `closegraph()` — переключение VGA в графический режим 12h и обратно в текстовый
- **Пиксели**: `putpixel()` / `getpixel()` — побитовая работа с 4 плоскостями VGA через регистры sequencer и GC
- **Линии**: `line()` — алгоритм Брезенхема + оптимизированные горизонтальные и вертикальные линии
- **Прямоугольники**: `rectangle()`, `bar()` — побайтовая заливка с поддержкой паттернов заливки
- **Текст**: `outtextxy()` — встроенный bitmap-шрифт 8×8 CP437 (96 символов, зашитых в массив внутри файла)
- **Изображения**: `getimage()` / `putimage()` — работа с 4 плоскостями, оптимизированный COPY_PUT, fallback для XOR/OR/AND/NOT
- **Стили**: `setcolor()`, `setfillstyle()`, `setfillpattern()`, `setlinestyle()` — полная совместимость с BGI API

Вся графика работает через **прямой доступ к видеопамяти** по адресу `0xA0000` с программированием VGA sequencer и Graphics Controller регистров.

#### MAKEFILE — скрипт сборки (45 строк)

Файл для утилиты `wmake` (аналог `make` в Open Watcom). Описывает зависимости между файлами и правила компиляции/линковки.

### Изменения в существующих файлах

При портировании исходные файлы программы были изменены минимально — основная работа выполнена через COMPAT.H:

| Аспект | 16-bit (Borland) | 32-bit (Watcom) | Где изменено |
|--------|-------------------|-----------------|-------------|
| Массив точек | `int huge *iTabl` | `short *iTabl` | PROJ5.H |
| Аллокатор | `farmalloc()` | `malloc()` (через COMPAT.H) | PROJ5.CPP |
| Включения | `<graphics.h>`, `<alloc.h>` | `"bgi32.h"`, `"compat.h"` | PROJ5.H |
| BFT-формат | `sizeof(int)` = 2 байта | `sizeof(short)` = 2 байта (явно) | RDWRF.CPP |
| Мышиный курсор | `int86x(0x33)` + битовая маска | Заглушка `set_gr_cursor()` (вызов GPF в DOS/4GW) | MSKEYC.CPP |
| Модификаторы `far`/`huge` | Повсеместно | Удалены (плоская модель памяти) | Все файлы |

> **Почему `int` → `short`?** В 16-битном Borland C++ `sizeof(int)` = 2 байта, что совпадает с размером координат в BFT-файле. В 32-битном Watcom `sizeof(int)` = 4 байта. Чтобы сохранить совместимость с бинарным форматом BFT, тип массива заменён на `short` (всегда 2 байта).

> **Почему заглушка мышиного курсора?** Установка пользовательской формы курсора мыши через прерывание `int 33h` (функция AX=9) требует передачи far-указателя на битовую маску. В 32-битном protected mode (DOS/4GW) это вызывает General Protection Fault, поскольку far-указатели несовместимы с реальным режимом обработчика мыши. Курсор отображается стандартный.
