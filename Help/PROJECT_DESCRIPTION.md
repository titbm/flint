# FLINT+ — Программа управления лазерной гравировальной установкой

## Что это за программа?

**FLINT+** — это программа для управления **лазерной установкой**, которая создаёт **объёмные изображения внутри стекла**. Вы наверняка видели такие сувениры: стеклянный кубик, а внутри — 3D-модель здания, логотип, фигурка или надпись. Именно для производства таких изделий и предназначена эта программа.

### Как работает технология?

Представьте себе стеклянный кубик, закреплённый на подвижном столике. Над ним — мощный лазер. Лазерный луч фокусируется **внутри** стекла (а не на поверхности) и создаёт крошечную микротрещину — **одну точку** размером с песчинку. Затем столик чуть-чуть сдвигается, и лазер делает следующую точку. Из тысяч таких точек складывается трёхмерное изображение.

Программа FLINT+ делает всю работу:
- Загружает 3D-модель (набор координат точек)
- Двигает столик с точностью до сотых долей миллиметра
- Следит за безопасностью (лазерные затворы, концевые датчики)
- Стреляет лазером в нужный момент

### Кто и когда это сделал?

- **Разработчик**: автор под псевдонимом «iB»
- **Организация**: ИЛТиП (ILTiP Ltd) — Институт лазерных технологий и инжиниринга, г. Сосновый Бор, Ленинградская область, Россия
- **Телефон**: +7(81269)22622
- **Годы разработки**: с 1996 по 2003 год
- **Текущая версия**: 2.61 (январь 2003)

---

## На чём написана программа?

| Что | Чем сделано |
|-----|-------------|
| **Язык программирования** | C/C++ |
| **Среда разработки** | Borland C++ (IDE 90-х годов) |
| **Операционная система** | MS-DOS — старая текстовая операционка, которая была до Windows |
| **Графика** | Собственная графическая библиотека Borland (BGI) — рисует окна, кнопки, картинки прямо на экране в режиме 640×480 пикселей |
| **Управление оборудованием** | Прямые команды в электронные платы через порты ввода-вывода — программа напрямую «разговаривает» с железом |

> **Почему DOS, а не Windows?** В 1996 году для управления оборудованием в реальном времени DOS подходил лучше — он не отвлекался на другие задачи и давал программе полный контроль над компьютером и подключёнными устройствами.

---

## Какое оборудование подключено?

Программа управляет целым набором устройств, подключённых к компьютеру через специальные платы расширения:

### Координатный столик (3 оси)
Стеклянный образец закрепляется на столике, который может двигаться по трём направлениям:
- **Ось X** — влево/вправо (до 235 мм)
- **Ось Y** — вперёд/назад (до 235 мм)
- **Ось Z** — вверх/вниз (до 110 мм)

Столик приводят в движение **шаговые двигатели** — моторчики, которые поворачиваются ровно на один «шажок» по команде компьютера. Один шаг — примерно 0.01 мм. Это позволяет позиционировать образец с очень высокой точностью.

### Лазер
Мощный импульсный лазер (предположительно Nd:YAG). Каждый «выстрел» создаёт одну точку внутри стекла. Программа управляет:
- **Включением/выключением** лазера
- **Частотой импульсов** (период от 20 до 2000 мс)
- **Защитным затвором** — механическая шторка, которая блокирует луч, когда лазер не нужен

### Датчики безопасности
- **6 концевых датчиков** (по 2 на каждую ось) — не дают столику «уехать» за пределы и сломать механику
- **10 датчиков контроля затворов** — проверяют, что при каждом импульсе нужные затворы действительно открылись

### Электромагнитные затворы (10 штук)
Установка может обрабатывать **до 9 образцов одновременно**. Каждому образцу соответствует свой затвор (EM1–EM9), плюс один общий (EM10). Перед каждым импульсом затворы переключаются так, чтобы луч попал именно в нужный образец.

### CMOS-счётчик (с батарейкой)
Специальная микросхема со своей батарейкой, которая запоминает, сколько точек уже обработано. Если вдруг отключится электричество — после включения можно продолжить с того места, где остановились, а не начинать заново.

---

## Что умеет программа? (Все возможности)

### Главный экран

При запуске программа показывает **главный экран** со следующей информацией:

- **Часы** — текущее время в углу экрана (обновляются каждую секунду)
- **Имя текущего файла** с данными
- **Nmax** — сколько всего точек в загруженном объекте
- **Nlast** — на какой точке остановились при последней обработке
- **Параметры стекла** — тип стекла, показатель преломления, размеры (X × Y × Z)
- **Контрольная картинка** — схематичное изображение объекта, можно переключать проекцию кнопкой F9 (вид сверху XY → вид сбоку YX → вид сбоку XZ → вид сбоку YZ)
- **Матрица затворов** (при работе с 9 образцами) — какие из 9 позиций активны
- **Расчётное время обработки** — сколько примерно займёт изготовление изделия (часы:минуты:секунды)
- **Логотип «FLINT»** — красивая надпись в правом верхнем углу
- **Индикатор «Demo»** — показывает, что оборудование не подключено (программа работает в режиме демонстрации)

В нижней и правой части экрана — **кнопки** для доступа ко всем функциям:

---

### F1 — Настройки (Configuration)

Центральное место для настройки всех параметров установки:

**Параметры лазера:**
- **Период лазера** (Las.puls period) — интервал между импульсами (от 20 до 2000 мс). Чем меньше — тем быстрее работа, но хуже качество
- **Частота шагов** (Step freq) — скорость перемещения столика (от 100 до 2000 Гц)
- **Режим скорости**: «постоянная» (constant) — столик всегда двигается с одной скоростью; «переменная» (variable) — скорость подстраивается так, чтобы перемещение успевало завершиться за время между импульсами

**Координаты указателя (X, Y, Z):**
- Задают, куда именно в стекле будет направлен лазерный фокус
- Можно менять кнопками +/– или вводить числа вручную
- При включённом режиме «Work ptr» столик **реально перемещается** при каждом изменении координат — удобно для юстировки (настройки точного положения)

**Режим работы:**
- **«1»** — один образец (один большой затвор)
- **«9»** — до 9 образцов одновременно (матрица 3×3 затворов). Можно мышкой включить/выключить любой затвор в матрице

**Безопасность:**
- **Protect open/close** — ручное открытие/закрытие защитного затвора лазера
- **Las.puls** — ручной одиночный импульс лазера (для тестирования)
- **Las.adjust** — режим юстировки: лазер стреляет непрерывно с текущим периодом, пока не нажата клавиша (для настройки оптики)

**Сохранение/загрузка:**
- **Load .cfg** — загрузить настройки из файла
- **Save .cfg** — сохранить текущие настройки

**Статистика:**
- **Flash nmb** — общее количество лазерных вспышек за всё время работы установки
- **Service date** — дата последнего обслуживания
- **Reset** — обнуление счётчика и установка новой даты обслуживания
- **Pixels max** — максимальное число точек, которое помещается в память

---

### F2 — Конвертер данных (Data Convert)

Мощный редактор для подготовки 3D-объектов перед гравировкой. Это «мастерская», где оператор загружает модель и подгоняет её под конкретный стеклянный образец.

**Загрузка данных:**
- Можно загрузить объект из **5 форматов**: BFT, CFT, ASC (3D Studio), BMP (чёрно-белое изображение)
- При загрузке BMP: чёрные пиксели становятся точками, можно настроить шаг dx/dy (расстояние между точками 0.1–1.5 мм) и dz (глубина второго слоя)

**Просмотр модели:**
- Контрольная картинка объекта с **4 проекциями** (кнопка «View XYZ»): XY, YX, XZ, YZ
- **Автомасштабирование** — объект всегда помещается на экран
- **Инвертирование** (Invert) — переключение между «светлые точки на тёмном фоне» и наоборот (позволяет увидеть, как будет выглядеть в стекле)

**Редактирование позиции:**
- Кнопки **up/down/←/→** — сдвиг объекта внутри образца (шаг 0.25 мм)
- **«0→Center»** — сдвиг начала координат в центр образца
- **«C→Center»** — автоматическое центрирование объекта (геометрический центр объекта совмещается с центром стекла)
- **Показатели dT, dL, dR, dB** — расстояния от объекта до краёв стекла (Top/Left/Right/Bottom) в миллиметрах. Можно ввести нужное расстояние вручную

**Редактирование параметров стекла:**
- **Тип стекла** — выбор из справочника (кнопка «Glass:» открывает окно Glass Select)
- **Показатель преломления** (n) — можно ввести вручную (от 1.000 до 2.000)
- **Размеры образца** (Xsize, Ysize, Zsize) — в миллиметрах, можно менять кнопками или вводить вручную

**Зеркальное отражение (Mirror):**
- Переворачивает объект по горизонтали — нужно для того, чтобы при взгляде на стекло с определённой стороны изображение было правильным

**Масштабирование (Dimensions Modification):**
- Отдельное окно для изменения размера объекта
- **Общий коэффициент K** — от 50% до 200% (уменьшить вдвое или увеличить вдвое)
- **Раздельные коэффициенты** Kx, Ky, Kz — можно растягивать/сжимать по отдельным осям
- **Точка отсчёта**: «from 0» — от начала координат; «from centre» — от центра стекла
- После нажатия «Ok» координаты всех точек пересчитываются

**Сортировка (Sort):**
- Отдельное окно для оптимизации порядка точек
- Зачем: если после каждого импульса столик перемещается на небольшое расстояние — работа идёт быстрее и качественнее, чем если он «прыгает» через весь образец
- **Три режима**:
  - **Off** — сортировка отключена (точки в том порядке, как были в файле)
  - **0.5mm layers** — двухэтапная сортировка: сначала точки группируются по «слоям» толщиной 0.5 мм по оси Z, затем внутри каждого слоя выстраиваются в оптимальный маршрут (минимальное перемещение между соседними точками)
  - **K*dz** — «умная» сортировка с коэффициентами. Алгоритм «ближайшего соседа» с учётом направления по Z: движение «вниз» (K1) и «вверх» (K2) имеют разный «вес» (по умолчанию K1=15, K2=10). Это учитывает, что двигаться вглубь стекла «дешевле», чем обратно
- **Sort/time** — запуск сортировки с подсчётом расчётного времени обработки
- Все три режима с прогресс-баром и возможностью прерывания по ESC

**Сохранение результата:**
- **Data Save** — сохранение подготовленного объекта в форматы BFT, CFT или ASC
- При сохранении автоматически применяются: сдвиг позиции, зеркалирование, пересчёт по преломлению стекла

---

### F3 — Загрузка данных (Data Load)

Быстрая загрузка файла с точками **для обработки** (прямо из главного экрана, без конвертера):
- Выбор файла через навигатор (каталоги, диски, имя файла)
- Поддержка форматов **BFT** и **CFT**
- После загрузки объект сразу отображается на главном экране, подсчитывается время обработки

---

### F4 — Загрузка стекла (Glass Load)

Окно для физической загрузки/выгрузки стеклянных образцов:
- **Up** — столик поднимается вверх до концевых датчиков: сначала быстрый ход, затем точная привязка. После этого координаты известны, и можно начинать работу
- **Down** — столик опускается вниз для замены образцов
- **Cancel** — отмена без перемещения

---

### F5 — Запуск обработки (Start)

Самая важная функция — **запуск процесса гравировки**. Окно с множеством настроек:

**Откуда начать:**
- **Beginning** — с самого начала (счётчик CMOS обнуляется, статистика повторов сбрасывается)
- **Point number** — с произвольной точки (можно ввести номер кнопками +/–/++/––)
- **Continuation** — продолжить с того места, где остановились в прошлый раз
- **Saved in CMOS** — восстановить позицию из аппаратного счётчика (после аварийного выключения питания)

**Безопасность:**
- **End sensors** — если включено, перед началом работы столик обязательно «привязывается» к концевым датчикам (для точного определения нулевой точки)
- **Drawing check** — если включено, после каждого импульса программа проверяет по датчикам, что все затворы действительно сработали. Если нет — до 10 повторных попыток
- **Реакция на помехи (After noise):**
  - **Stop** — полная остановка с сообщением об ошибке
  - **Coord.reboot/continuation** — автоматическая перепривязка к датчикам и продолжение работы
  - **Ignore** — игнорировать помеху и продолжить

**Предпусковые проверки:**
- Программа проверяет, что все точки объекта не выходят за **пределы хода столика** (0–235 мм по X и Y, 0–110 мм по Z)
- Проверяет, что точки не выходят за **пределы стеклянного образца**
- Если что-то не так — выдаёт предупреждение и не позволяет запустить процесс

**Сам процесс:**
- В нижней части экрана — **прогресс-бар** и текущий номер точки
- В верхней части — сообщение «For STOP: press ESC»
- Для каждой точки: вычисление координат → перемещение столика → лазерный импульс с контролем затворов → отрисовка точки на контрольной картинке → инкремент CMOS-счётчика
- При ошибке лазера: окно «Check laser. Retry: Ok» с тремя вариантами — «Ok» (повторить), «No» (остановить), «Nx» (пропустить эту точку и перейти к следующей)
- По окончании: три звуковых сигнала и сообщение «Ok. TABLE END»

---

### F6 — Статистика (Statistics)

Отображает сводную информацию о работе установки:

- **Total flash nmb** — сколько всего лазерных вспышек сделала установка за всё время (данные хранятся в файле flash.dat)
- **Service date** — дата последнего обслуживания
- **Total px.nmb** — сколько точек в текущем объекте
- **Stopped after** — на какой точке остановилась последняя обработка
- **Матрица ошибок** — визуальная схема 3×3 (+ десятый затвор): какие затворы срабатывали с ошибкой
- **Reiterations (повторные попытки):**
  - **1st** — количество первых повторных срабатываний по каждому затвору
  - **next** — количество последующих повторов
  - **Total** — суммарные числа

---

### F7 — О программе (Version / Info)

Небольшое окно с информацией:
- Название организации: «ILTiP Ltd»
- Город: «RUSSIA Sosnovy Bor»
- Телефон
- Версия программы (2.61 iB)
- Иконка-логотип института (нарисованная попиксельно)

---

### F9 — Переключение проекции (XYZ)

Циклически переключает **ракурс контрольной картинки** на главном экране:
- XY (вид сверху) → YX (перевёрнутый вид) → XZ (фронтальный вид сбоку) → YZ (боковой вид сбоку) → снова XY

---

### F10 — Выход (Exit)

Запрос подтверждения «Exit?» и выход из программы. Освобождает память и закрывает графический режим.

---

### Демо-режим

Если при запуске программа **не обнаруживает подключённых плат**, она автоматически включает **демонстрационный режим**. В этом режиме:
- Все перемещения столика **эмулируются** (с задержками, имитирующими реальное время)
- Лазерные импульсы лишь увеличивают счётчик
- Все меню и функции работают полностью
- На экране отображается надпись «Demo»

Это позволяет изучать программу, готовить файлы и тестировать настройки без подключения к реальной установке.

---

### Навигатор файлов

Во всех окнах открытия/сохранения файлов работает **встроенный файловый менеджер**:
- Список подкаталогов с прокруткой (переход по клику или кнопками up/down)
- Список файлов (отфильтрованных по типу) с прокруткой
- **Переключение типа файлов** (bft/cft/asc/bmp) чекбоксами
- **Смена диска** (A:–J:) через выпадающее меню
- **Ручной ввод имени файла** с клавиатуры
- Текущий путь отображается вверху окна
- Файлы и каталоги отсортированы по алфавиту

---

### Управление по справочнику стёкол

В файле FLINT.GLS хранится каталог марок стекла с их характеристиками. Окно «Glass Select» (вызывается из конвертера) позволяет:
- Выбрать марку стекла из списка (К8, ТФ10, ЛК3, СТК и др.)
- Автоматически установить показатель преломления для выбранной марки
- Список с прокруткой, отображение марки и числового значения n

---

## Понятие «показатель преломления» и зачем он нужен

Когда лазерный луч входит в стекло, он **отклоняется** (преломляется). Из-за этого точка фокусировки оказывается не там, где ожидалось. Чем «плотнее» стекло — тем сильнее отклонение. Показатель преломления (n) — число, которое описывает это свойство (для обычного стекла ~ 1.5). Программа учитывает это число при пересчёте координат по оси Z, чтобы точки оказались **точно на своих местах** внутри стекла.

---

## Форматы файлов данных

### BFT (Binary Flint Table) — основной формат
**Двоичный** (компактный, нечитаемый глазом) файл:
- Заголовок: «bf», показатель преломления, размеры стекла, количество точек
- Далее — координаты X, Y, Z для каждой точки
- Быстро загружается, занимает мало места

### CFT (Character Flint Table) — текстовый формат
**Текстовый** (можно открыть в блокноте) файл:
```
flinttab
nglass=	1.506
xsize=	50
ysize=	50
zsize=	50
1:	120	340	80
2:	125	342	80
...
```
Удобен для отладки, но загружается медленнее.

### ASC — формат 3D Studio
Текстовый экспорт из программы **Autodesk 3D Studio** (популярный 3D-редактор тех лет). Можно создать модель в 3D Studio и экспортировать для гравировки.

### BMP — чёрно-белое изображение
Обычная картинка формата Windows Bitmap, но строго **двухцветная** (чёрно-белая). Чёрные пиксели превращаются в точки для гравировки. Можно задать шаг и глубину — получится плоское или двухслойное изображение внутри стекла.

---

## Файловая структура проекта

### Исходный код программы

| Файл | Зачем нужен |
|------|-------------|
| [PROJ5.CPP](PROJ5.CPP) | **Главный файл программы.** Всё, что вы видите на экране: меню, кнопки, окна настроек, конвертер данных, окно запуска — всё здесь. Также здесь логика запуска, сортировка точек и расчёт времени. Это самый большой файл — около 1500 строк |
| [PROJ5.H](PROJ5.H) | **Файл настроек и данных.** Здесь хранятся: расположение всех кнопок на экране (координаты, размеры), цвета интерфейса, адреса портов оборудования, шрифтовые данные для логотипа, маска курсора мыши, все глобальные переменные программы. Без этого файла остальные не скомпилируются |
| [PIC.CPP](PIC.CPP) | **Файл управления оборудованием.** Здесь «живёт» вся работа с реальным железом: инициализация плат, перемещение столика, лазерные импульсы, контроль затворов и датчиков, основной цикл обработки (прохождение по всем точкам). Примерно 420 строк |
| [MSKEYC.CPP](MSKEYC.CPP) | **Файл работы с мышью и клавиатурой.** Инициализация мыши, обработка кликов, нажатий клавиш, автоповтор при удержании кнопки, управление курсором со стрелок клавиатуры, вывод часов, звуковой сигнал. Примерно 165 строк |
| [RDWRF.CPP](RDWRF.CPP) | **Файл чтения и записи данных.** Открытие/сохранение файлов всех форматов (BFT, CFT, ASC, BMP), работа с каталогами и дисками, чтение/запись конфигурации, загрузка каталога стёкол, работа со счётчиком вспышек. Примерно 400 строк |
| [Proj5.ide](Proj5.ide) | **Файл проекта.** Служебный файл среды Borland IDE — описывает, из каких файлов состоит программа и как их компилировать. Для понимания кода не нужен |

### Файлы конфигурации и справочники

| Файл | Зачем нужен |
|------|-------------|
| [FLINT1.CFG](FLINT1.CFG) | **Настройки для режима «1 образец».** Хранит координаты указателя (X,Y,Z), размер шага, период лазера, частоту шагов и режим скорости. Загружается при старте программы. Двоичный файл, 40 байт |
| [FLINT9.CFG](FLINT9.CFG) | **Настройки для режима «9 образцов».** Те же данные, что в FLINT1.CFG, плюс информация о том, какие из 9 затворов активны |
| [FLINT.GLS](FLINT.GLS) | **Справочник марок стекла.** Текстовый список: марка стекла и её показатель преломления. Например: К8 = 1.506, ТФ10 = 1.557, ЛК3 = 1.692. Используется при выборе стекла в конвертере |

### Примеры 3D-объектов

| Файл | Зачем нужен |
|------|-------------|
| [cube.bft](cube.bft) | Готовый объект — **куб** (набор точек, образующих трёхмерный каркас куба). Для тестирования и демонстрации |
| [sphere.bft](sphere.bft) | Готовый объект — **сфера**. Для тестирования и демонстрации |
| [spiral.bft](spiral.bft) | Готовый объект — **спираль**. Для тестирования и демонстрации |

### Документация (история изменений)

| Файл | Зачем нужен |
|------|-------------|
| [Flint.txt](Flint.txt) | **Журнал изменений** (начиная с версии 2.61). Описание что нового в каждой версии, какие ошибки исправлены |
| [FLINTOLD.TXT](FLINTOLD.TXT) | **Старый журнал** (версии 1.0–2.43, 1996–1998). Полная история с самого начала: как программа появилась и развивалась |
| [Flintold2.txt](Flintold2.txt) | **Средний журнал** (версии 2.43–2.60, 1999). Период внедрения на производстве в Минске (LOTIS TII) |

### Папка Decoded/

| Файл | Зачем нужен |
|------|-------------|
| Decoded/* | Копии исходных файлов с **перекодированными комментариями**. Оригинальные файлы написаны в кодировке DOS (CP866) — в современных редакторах русские комментарии выглядят как «кракозябры». Файлы в папке Decoded — те же исходники, но с читаемыми комментариями |

---

## Типичный рабочий процесс оператора

Вот как выглядит работа с программой от начала до конца:

1. **Запуск программы** — загружается главный экран. Если оборудование подключено, программа определяет его автоматически. Если нет — включается демо-режим.

2. **Загрузка 3D-модели** (F2 → Data Load) — оператор открывает файл с объектом (например, cube.bft) через файловый навигатор.

3. **Подготовка объекта** (F2) — в окне конвертера:
   - Выбрать марку стекла и задать размеры
   - Отцентрировать объект кнопкой «C→Center»
   - При необходимости — отзеркалить, масштабировать
   - Запустить сортировку для оптимального маршрута
   - Сохранить подготовленный файл (Data Save)

4. **Загрузка для обработки** (F3) — загрузить подготовленный файл на главный экран.

5. **Настройка оборудования** (F1) — задать период лазера, частоту шагов, режим скорости. При необходимости — юстировка (Las.adjust).

6. **Установка образца** (F4 → Down) — столик опускается, оператор крепит стекло. Затем F4 → Up — столик поднимается и привязывается к датчикам.

7. **Запуск** (F5) — выбрать «Beginning», включить «End sensors» и «Drawing check», нажать «Start». Программа начинает гравировку.

8. **Наблюдение** — на экране шкала прогресса, номер текущей точки, контрольная картинка заполняется по мере обработки.

9. **Завершение** — три звуковых сигнала, надпись «TABLE END». Можно проверить статистику (F6) и извлечь готовое изделие (F4 → Down).

---

## Краткая история проекта

| Когда | Что произошло |
|-------|---------------|
| Июнь 1996 | Первая версия — программа просто двигает столик и стреляет лазером |
| Конец 1996 | Добавлен конвертер 3D Studio → формат FLINT, контрольная картинка, поддержка BMP, работа с 9 образцами, статистика |
| 1997 | Оптимизация маршрута (сортировка), масштабирование, контроль датчиков затворов |
| 1998 | Масштабирование по отдельным осям, выбор реакции на помехи |
| 1999 | Работа с каталогами и дисками, счётчик вспышек, центрирование объекта, внедрение на производстве в Минске |
| 2003 | **Версия 2.61** (текущая) — улучшенная сортировка, 10 повторных попыток, усовершенствованный интерфейс |

---

## Размер рабочей области

| Ось | Рабочий ход | В миллиметрах |
|-----|-------------|---------------|
| X (влево-вправо) | 0–23500 шагов | ~235 мм |
| Y (вперёд-назад) | 0–23500 шагов | ~235 мм |
| Z (вверх-вниз) | 0–11000 шагов | ~110 мм |

Максимальный размер стеклянного изделия — **235 × 235 × 110 мм**.
